<!DOCTYPE HTML> 
<html lang="en"> 
<head>
<title>Pixel-Art Editor</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta http-equiv="Content-Language" content="en-us"> 

<!--<link href="blank.css" rel="stylesheet" type="text/css">-->

<!--<link href='http://fonts.googleapis.com/css?family=Amaranth:400,400italic' rel='stylesheet' type='text/css'>-->
<link href='http://fonts.googleapis.com/css?family=Noto+Serif:400,400italic' rel='stylesheet' type='text/css'>

<link href="jqueryui/css/darkertheme/jquery-ui-1.10.4.custom.css" rel="stylesheet">
<link href="jqueryui/css/propertiestheme/jquery-ui-1.10.4.custom.css" rel="stylesheet">
<script src="jqueryui/js/jquery-1.10.2.js"></script>
<script src="jqueryui/js/jquery-ui-1.10.4.custom.js"></script>

<link type="text/css" href="jquery.jscrollpane.css" rel="stylesheet" media="all" />
<script src="jquery.mousewheel.js"></script>
<script src="mwheelIntent.js"></script>
<script src="jquery.jscrollpane.min.js"></script>

<script type="text/javascript" src="mousewheel_plugin.js"></script>

<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
<script type="text/javascript" src="peer.js"></script>

<script type="text/javascript" src="connection.js"></script>
<script type="text/javascript" src="misc.js"></script>
<script type="text/javascript" src="animation.js"></script>
<script type="text/javascript" src="toolcanvas.js"></script>
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript" src="canvas.js"></script>
<script type="text/javascript" src="palettecanvas.js"></script>
<script type="text/javascript" src="minicanvas.js"></script>
<script type="text/javascript" src="drawing.js"></script>
<script type="text/javascript" src="color_conversion.js"></script>
<script type="text/javascript" src="console-save.js"></script>
<script type="text/javascript" src="file.js"></script>
<script type="text/javascript" src="colorscan.js"></script>
<!--<script type="text/javascript" src="scale2x.js"></script>-->
<script type="text/javascript" src="scale2xb.js"></script>
<script type="text/javascript" src="gif.js"></script>
<!--<script type="text/javascript" src="gif.worker.js"></script>-->
<script type="text/javascript" src="gifjs/libgif.js"></script>

<script type="text/javascript" src="v1_0_0.js"></script>

		
<style>
	body, html {
		height: 100%;
		padding:0px;
		margin:0px;
	}
	body{
		background: #222222;
		font-family: 'Noto Serif', sans-serif;
		font-size:12px;
		font-weight: 400;
		color: #eeeeee;
		text-shadow: -1px -1px 0 #222222;
	}
	
	.bottomtext{
		text-align: left;
		font-family: 'Noto Serif', sans-serif;
		font-size:12px;
		font-weight: 400;
		color: #000000;
		text-shadow: 1px 1px 0 #dadada;
	}
	.my-container{
		border: solid 1px #333333;
		background: #242424;
	}
	
	.my-header{
		font-family: 'Noto Serif', sans-serif;
		font-size:12px;
		font-weight: 400;
		font-style: italic; 
		color: #eeeeee;
		text-shadow: -1px -1px 0 #222222;
		padding:2px;
		border: solid 1px #777777;
		border-radius: 3px 3px 0 0;
		background: #7f7f7f;
		background: -moz-linear-gradient(top, #7f7f7f 0%, #595959 100%);
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#7f7f7f), color-stop(100%,#595959));
		background: -webkit-linear-gradient(top, #7f7f7f 0%,#595959 100%);
		background: -o-linear-gradient(top, #7f7f7f 0%,#595959 100%);
		background: -ms-linear-gradient(top, #7f7f7f 0%,#595959 100%);
		background: linear-gradient(to bottom, #7f7f7f 0%,#595959 100%);
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7f7f7f', endColorstr='#595959',GradientType=0 );
	}
	
	.my-toolbar{
		border: solid 1px #777777;
		background: #7f7f7f;
		background: -moz-linear-gradient(left, #7f7f7f 0%, #595959 100%);
		background: -webkit-gradient(linear, left top, right top, color-stop(0%,#7f7f7f), color-stop(100%,#595959));
		background: -webkit-linear-gradient(left, #7f7f7f 0%,#595959 100%);
		background: -o-linear-gradient(left, #7f7f7f 0%,#595959 100%);
		background: -ms-linear-gradient(left, #7f7f7f 0%,#595959 100%);
		background: linear-gradient(to right, #7f7f7f 0%,#595959 100%);
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7f7f7f', endColorstr='#595959',GradientType=1 );
	}
	
	.ui-state-default.transparentbutton{
		background:transparent;
		border:#222222;
	}
	.ui-state-hover.transparentbutton{
		background: url("jqueryui/css/darkertheme/images/ui-bg_highlight-soft_33_003147_1x100.png") 50% 50% repeat-x;
	}
	
	.ui-slider .ui-slider-handle{
		width:8px; 
		height:8px; 
		margin-left: -4px;
		position:absolute;
		top: 0px; 
	}

	.southwest{ position:absolute; left:0px; bottom:0px; width:9px; height:9px; background:url("icon-sw.png") no-repeat;}
	.handle { background: #353566; position: absolute; left: 0; top: 0; bottom: 0; padding:8px; }
	.ui-selecting .handle { background: #444477; }
	.ui-selected .handle { background: #4444bb; }
	.smallericon {height: 16px;}
	.penicon {height: 18px;}
	.dropdown {
		padding:3px;
		margin: 2px;
		font-size:10px;
		-webkit-border-radius:4px;
		-moz-border-radius:4px;
		border-radius:4px;
		
		background: #333333;
		color:#ffffff;
		border:solid 1px #666666;
		outline:none;
		display: inline-block;
		cursor:pointer;
	}
	
	.infotab {
		padding:3px;
		margin: 0px 1px 6px 0px;
		-webkit-border-radius: 0px 0px 4px 4px;
		-moz-border-radius: 0px 0px 4px 4px;
		border-radius: 0px 0px 4px 4px;
		border:solid #999999;
		border-width:0px 1px 1px 1px ;
		background:#bbbbbb;
	}
	.infotab:hover {
		background:#cccccc;
		cursor:pointer;
	}
	.infobox {
		border:solid #999999;
		border-width: 0px 0px 0px 1px;
		height:100%;
	}
	
	canvas { 
		cursor: crosshair;
		user-select: none;
		-webkit-user-select: none;
		-moz-user-select: none;
        image-rendering: optimizeSpeed;             // Older versions of FF
		image-rendering: -moz-crisp-edges;          // FF 6.0+
		image-rendering: -webkit-optimize-contrast; // Webkit
													//  (Safari now, Chrome soon)
		image-rendering: -o-crisp-edges;            // OS X & Windows Opera (12.02+)
		image-rendering: optimize-contrast;         // Possible future browsers.
		-ms-interpolation-mode: nearest-neighbor;   // IE
	
	}



</style>

<script>


// Handle a connection object.
function connect(c) {

  if (c.label === 'chat') {
  
	connlist.push(c.id);		//The id of established connection between two peers
	
	var findpeer = $.grep(peerlist, function(e){ return e == c.peer; });
	if(findpeer.length==0 && c.metadata.from!=peer.id){
		//console.log(c.metadata.invitation+","+c.metadata.message);
		$("#popup_title").html('Invitation');
		$("#popup_content").html('<div id="MenuDialog">\
			'+c.peer+' is inviting you to a paint session. If you accept, any work you\'ve already made will be erased.\
		</div>');
		$("#popup_container").show();
		$("#popup_title").show();
		$("#popup_submit").unbind( "click" );
		$("#popup_submit").children('span:first').html('Accept');
		$("#popup_submit").click(function(){
			reset_project(c.metadata.frames, c.metadata.width, c.metadata.height);
			project.invite = c.metadata.connectionlist;
			project.lock = true;	//ensure we wait until everyone is connected before drawing.
			connectToDraw(c.peer);
			c.metadata.connectionlist.forEach( function(entry){
				connectToDraw(entry);
				connectTo(entry);
			});
			$("#popup_container").hide();	
			$("#popup_title").hide();	
			$("#popup_submit").children('span:first').html('Submit');		
			$("#popup_cancel").children('span:first').html('Cancel');			
		});
		$("#popup_cancel").unbind( "click" );
		$("#popup_cancel").children('span:first').html('Decline');
		$("#popup_cancel").click(function(){
			$("#popup_container").hide();	
			$("#popup_title").hide();		
			$("#popup_submit").children('span:first').html('Submit');		
			$("#popup_cancel").children('span:first').html('Cancel');			
		});
	}
	
	c.on('data', function(data) {
		if(data.type=="message"){
			$('#msgbox').append('<div style="direction:ltr;"><span class="peer">' + c.peer + '</span>: ' + data.text +
			'</div>');
		}
	});
	
	c.on('close', function() {
		//alert(c.peer + ' has left the lobby.');
		$('#msgbox').append('<div style="direction:ltr;"><span class="peer">' + c.peer + '</span>' + ' has left the lobby.' +
			'</div>');
			
		var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
		if(peerhistory.length>0)historylist.splice(historylist.indexOf(peerhistory[0]),1);
		var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
		if(peerlayer.length>0)brushlayers.splice(brushlayers.indexOf(peerlayer[0]),1);

		delete connectedPeers[c.peer];
		connlist.splice(connlist.indexOf(c.id),1);
	  
	});
	
	connectedPeers[c.peer] = 1;
	
  }else if (c.label === 'draw') {
    /*var chatbox = $('<div></div>').addClass('connection').addClass('active').attr('id', c.peer);
    var header = $('<h1></h1>').html('Chat with <strong>' + c.peer + '</strong>');
    var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
    chatbox.append(header);
    chatbox.append(messages);
 
    // Select connection handler.
    chatbox.on('click', function() {
      if ($(this).attr('class').indexOf('active') === -1) {
        $(this).addClass('active');
      } else {
        $(this).removeClass('active');
      }
    });
    $('.filler').hide();
    $('#connections').append(chatbox);
	*/
	
	
	peerlist.push(c.peer);		//the id of the connecting peer
	connlist.push(c.id);		//The id of established connection between two peers
	//console.log(c.peer+","+c.id);
	var userlist = document.getElementById('userlist');
	userlist.innerHTML = 'Painting with ' + peerlist.join(", ");
	//userlist.innerHTML = userlist.innerHTML + ' ' + c.peer;
	
	historylist.push(new historydata(c.peer,0) );
	
	//New peer is connected, so now lock my app until all other peers connected to me have also connected to the new peer.
	//This will ensure that the new peer retrieves an accurate image of the canvas. Then I'll be able to draw again.
	prelockCleanup();
	project.lock = true;
	//also record new peer event in our live recording (adding peer to recording will make sure their historylist/layers get created during playback).
	project.recording.session[project.recording.session.length-1].peerlist.push(c.peer);
	
	c.on('open', function(id) {
	
		if(c.metadata.from!=peer.id){
			//commit our historylist then clear it.
			//var selected = myHistory[0].selected;
			send_history_select(myHistory[0].selected);
			//console.log(selected);
			commitHistory(myHistory[0].id);
			clearHistory(myHistory[0].id);
			myHistory[0].layers.push(new historylayerdata("New",myHistory[0].canvas,myHistory[0]) );
			//console.log(selected);
			//make sure any peers connected to me has an updated historylist of mine now that it has been cleared.
			send_clearHistory();
			//send current canvas (whichever user is last connected should end up sending the most accurate picture)
			
			var canvasdata = [];
			project.canvaslayer.forEach(function(entry){
				canvasdata.push( entry.toDataURL() );
			});
			
			var sortarray = $( "#frame_list" ).sortable('toArray', {attribute: 'value'});
			sortarray.shift();
			sortarray = sortarray.map(function (x) { 
				return parseInt(x, 10); 
			});
			
			var framedata = new Array(project.frames);
			for(var i=0; i<project.frames; i++){
				framedata[i] = {interval:300, visible:true, opacity:1, linked: false};
				var theframe = $("#frame_null").siblings(':eq('+i+')');
				framedata[i].interval = theframe.attr('data-interval');
				framedata[i].visible = project.visible[theframe.attr('value')];
				framedata[i].opacity = project.opacity[theframe.attr('value')];
				framedata[i].linked = (theframe.find('.frame_linker').attr('style').indexOf('-linked')!==-1 ? true : false );
			}
	
			var conns = peer.connections[c.metadata.from];
			for (var i = 0, ii = conns.length; i < ii; i += 1) {
			  var conn = conns[i];
			  
			  if(connlist.indexOf(conn.id)!=-1 ){
				var msg = {type:'refresh_canvas', canvas:canvasdata, order:sortarray, frame:framedata };
				conn.send( msg );
			  }
			}
		}
	});
	
	c.on('data', function(data) {
		if(data.type!="message" && data.type!="refresh_canvas" && data.type!="unlock_me"){
			//record this event in our session(for playback)
			var msg = data;
			msg.peer = c.peer;
			var msgcopy = jQuery.extend(true, {}, msg);
			project.recording.session[project.recording.session.length-1].actionlist.push( msgcopy );
		}
		
		if(data.type=="message"){
			$('#msgbox').append('<div style="direction:ltr;"><span class="peer">' + c.peer + '</span>: ' + data.text +
			'</div>');
		}else if(data.type=="refresh_canvas"){
			data.canvas.forEach( function(entry){
				var img = new Image()
				img.onload = function(){
					project.contextlayer[data.canvas.indexOf(entry)].clearRect(0,0, project.width, project.height);
					project.contextlayer[data.canvas.indexOf(entry)].drawImage(this,0,0);
				};
				img.src = entry;
			});
			//remove this peerid from our invite list so we'll know when all peers have been added.
			var remove = project.invite.indexOf(c.peer);
			if(remove>-1)project.invite.splice(remove,1);
			//if invite has no more items, send message to everyone informing them that it is okay to unlock themselves.
			if(project.invite.length==0){
				//also sort our frames and set our session canvases incase we want to playback our session
				data.order.forEach(function(entry){
					$("#frame_list").append( $('#frame_'+entry) );
				});
				project.recording.session[0].canvasdata = [];
				data.canvas.forEach(function(entry){
					project.recording.session[0].canvasdata.push(entry );
				});
				
				project.recording.session[0].frameinterval = new Array(project.frames);
				project.recording.session[0].framelinked = new Array(project.frames);
				//apply frame data to our frames so they match peers
				data.frame.forEach(function(entry){
					var theframe = $("#frame_null").siblings(':eq('+data.frame.indexOf(entry)+')');
					theframe.attr('data-interval',entry.interval);
					theframe.find('.frame_interval').html(entry.interval*0.001);
					project.recording.session[0].frameinterval[theframe.attr('value')]=entry.interval;
					theframe.find('.frame_visible').attr('src','eye-'+(entry.visible==false?'shut':'open')+'.png');
					theframe.find('.frame_linker').css('background-image','url(icon-'+(entry.linked==false?'un':'')+'linked.png)');
					project.recording.session[0].framelinked[theframe.attr('value')]=entry.linked;
					project.visible[theframe.attr('value')] = entry.visible;
					project.opacity[theframe.attr('value')] = entry.opacity;
				});
				project.recording.session[0].framevisible = project.visible;
				project.recording.session[0].frameopacity = project.opacity;
				
				project.lock=false;
				
				$("#progressbar").progressbar( "option", {
					value: 100
				});
				$("#connecting_info").text('Connected! Project is unlocked.');
				
				var msg = {type:'unlock_me' };
				eachActiveConnection(function(entry) {
					entry.send(msg);					
				});
			}
			
		}else if(data.type=="unlock_me"){
			project.lock = false;
			$("#progressbar").progressbar( "option", {
				value: 100
			});
			$("#connecting_info").text('Connected! Project is unlocked.');
		}else if(data.type=="mouse_position"){
			mouse.pos.x = data.x;
			mouse.pos.y = data.y;
			contextlayer.fillStyle = "rgba(0,0,0,1)";
			contextlayer.fillRect( mouse.pos.x, mouse.pos.y, 1, 1 );
		}else if(data.type=="draw_pixel"){
			contextlayer.fillStyle = data.color;
			contextlayer.fillRect( data.x, data.y, 1, 1 );
		}else if(data.type=="eraser_line"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			if(peerhistory[0].setclip==true){
				peerhistory[0].clip.x = data.ex, peerhistory[0].clip.y = data.ey;
				peerhistory[0].clip.x2 = data.ex, peerhistory[0].clip.y2 = data.ey;
			}
			peerhistory[0].setclip = false;
			commitHistory(c.peer);
			erase_line(project.contextlayer[data.frame], data.sx, data.sy, data.ex, data.ey, data.color, data.t, c.peer);
		}else if(data.type=="draw_magiceraser_line"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//check if we should add new canvas layer
			var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
			if(peerlayer.length==0){
				brushlayers.push(new brushlayerdata(c.peer,data.frame) );
			}else{
				peerlayer[0].frame = data.frame;
			}
			if(peerhistory[0].setclip==true){
				peerhistory[0].clip.x = data.ex, peerhistory[0].clip.y = data.ey;
				peerhistory[0].clip.x2 = data.ex, peerhistory[0].clip.y2 = data.ey;
			}
			peerhistory[0].setclip = false;
			commitHistory(c.peer);
			magiceraser_line(data.sx, data.sy, data.ex, data.ey, data.groups, data.t, data.basergba, data.baseuprgba, c.peer);
		}else if(data.type=="draw_pixel_line"){
			//check if we should add new historylist for peer
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==0){
				historylist.push(new historydata(c.peer,data.frame) );
				peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
				peerhistory[0].frame = data.frame;
				//historylist[historylist.length-1].frame = data.frame;
				console.log(historylist.length);
			}else{
				peerhistory[0].frame = data.frame;
			}
			if(peerhistory[0].setclip==true){
				peerhistory[0].clip.x = data.ex, peerhistory[0].clip.y = data.ey;
				peerhistory[0].clip.x2 = data.ex, peerhistory[0].clip.y2 = data.ey;
			}
			peerhistory[0].setclip = false;
			commitHistory(c.peer);
			pixel_line(project.contextlayer[data.frame], data.sx, data.sy, data.ex, data.ey, data.color, data.t, c.peer);
		}else if(data.type=="draw_brush_line"){
			//check if we should add new historylist for peer
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==0){
				historylist.push(new historydata(c.peer,data.frame) );
				peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
				peerhistory[0].frame = data.frame;
			}else{
				peerhistory[0].frame = data.frame;
			}
			//check if we should add new canvas layer
			var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
			if(peerlayer.length==0){
				brushlayers.push(new brushlayerdata(c.peer,data.frame) );
			}else{
				peerlayer[0].frame = data.frame;
			}
			if(peerhistory[0].setclip==true){
				peerhistory[0].clip.x = data.ex, peerhistory[0].clip.y = data.ey;
				peerhistory[0].clip.x2 = data.ex, peerhistory[0].clip.y2 = data.ey;
			}
			peerhistory[0].setclip = false;
			commitHistory(c.peer);
			brush_line(data.sx, data.sy, data.ex, data.ey, data.groups, data.t, data.basergba, data.baseuprgba, c.peer);
		}else if(data.type=="draw_flood_fill"){
			//check if we should add new historylist for peer
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==0){
				historylist.push(new historydata(c.peer,data.frame) );
				peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
				peerhistory[0].frame = data.frame;
			}else{
				peerhistory[0].frame = data.frame;
			}
			if(peerhistory[0].setclip==true){
				peerhistory[0].clip.x = data.pos.x, peerhistory[0].clip.y = data.pos.y;
				peerhistory[0].clip.x2 = data.pos.x, peerhistory[0].clip.y2 = data.pos.y;
			}
			peerhistory[0].setclip = false;
			commitHistory(c.peer);
			floodFill(project.contextlayer[data.frame], data.pos, data.color, data.contiguous, c.peer);
		}else if(data.type=="draw_pixel_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==1){
				peerhistory[0].setclip = true;
				//first save into historylist for this peer
				peerhistory[0].layers.push(new historylayerdata("",peerhistory[0].canvas,peerhistory[0]) );
				//then add to main canvas and clear from layer
				project.contextlayer[peerhistory[0].frame].drawImage(peerhistory[0].canvas,0,0);
				peerhistory[0].context.clearRect(0,0,peerhistory[0].canvas.width,peerhistory[0].canvas.height);
			}
		}else if(data.type=="draw_brush_clear"){
			var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
			if(peerlayer.length==1){
				var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
				peerhistory[0].setclip = true;
				//first save into historylist for this peer
				peerhistory[0].layers.push(new historylayerdata("",peerlayer[0].previewcanvas,peerhistory[0]) );
				//then add to main canvas and clear from layer
				project.contextlayer[peerlayer[0].frame].drawImage(peerlayer[0].previewcanvas,0,0);
				peerlayer[0].context.clearRect(0,0,peerlayer[0].canvas.width,peerlayer[0].canvas.height);
				peerlayer[0].previewcontext.clearRect(0,0,peerlayer[0].previewcanvas.width,peerlayer[0].previewcanvas.height);
			}
		}else if(data.type=="draw_bucket_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==1){
				peerhistory[0].setclip = true;
				//first save into historylist for this peer
				peerhistory[0].layers.push(new historylayerdata("",peerhistory[0].canvas,peerhistory[0]) );
				//then add to main canvas and clear from layer
				project.contextlayer[peerhistory[0].frame].drawImage(peerhistory[0].canvas,0,0);
				peerhistory[0].context.clearRect(0,0,peerhistory[0].canvas.width,peerhistory[0].canvas.height);
			}
		}else if(data.type=="eraser_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==1){
				peerhistory[0].setclip = true;
				//first save into historylist for this peer
				peerhistory[0].layers.push(new historylayerdata("",peerhistory[0].canvas,peerhistory[0]) );
				//then add to main canvas and clear from layer
				project.contextlayer[peerhistory[0].frame].globalCompositeOperation = 'destination-out';
				project.contextlayer[peerhistory[0].frame].drawImage(peerhistory[0].canvas,0,0);
				project.contextlayer[peerhistory[0].frame].globalCompositeOperation = 'source-over';
				peerhistory[0].context.clearRect(0,0,peerhistory[0].canvas.width,peerhistory[0].canvas.height);
			}
		}else if(data.type=="draw_magiceraser_clear"){
			var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
			if(peerlayer.length==1){
				var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
				peerhistory[0].setclip = true;
				//first save into historylist for this peer
				peerhistory[0].layers.push(new historylayerdata("",peerlayer[0].previewcanvas,peerhistory[0]) );
				//then add to main canvas and clear from layer
				project.contextlayer[peerlayer[0].frame].drawImage(peerlayer[0].previewcanvas,0,0);
				peerlayer[0].context.clearRect(0,0,peerlayer[0].canvas.width,peerlayer[0].canvas.height);
				peerlayer[0].previewcontext.clearRect(0,0,peerlayer[0].previewcanvas.width,peerlayer[0].previewcanvas.height);
				project.contextlayer[peerhistory[0].frame].globalCompositeOperation = 'destination-out';
				project.contextlayer[peerhistory[0].frame].drawImage(peerhistory[0].canvas,0,0);
				project.contextlayer[peerhistory[0].frame].globalCompositeOperation = 'source-over';
				peerhistory[0].context.clearRect(0,0,peerhistory[0].canvas.width,peerhistory[0].canvas.height);
			}
		}else if(data.type=="select_magic_wand"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			peerhistory[0].selectionclip = data.clip;
			//commitHistory(c.peer);
			magicWand(project.contextlayer[data.frame], data.pos, data.selecttype, data.contiguous, c.peer);
			peerhistory[0].context.clearRect(0, 0, peerhistory[0].canvas.width, peerhistory[0].canvas.height);
		}else if(data.type=="select_lasso"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			peerhistory[0].selectionpoints = data.points;
			peerhistory[0].selectionclip = data.clip;
			selectLasso(c.peer, data.selecttype);
		}else if(data.type=="select_move"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			peerhistory[0].selectionoffset = data.offset;
			peerhistory[0].selectionclip = data.clip;
		}else if(data.type=="select_flip"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			flipSelection(c.peer,data.flip);
		}else if(data.type=="select_rotate"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			rotateSelection(c.peer,data.rotate);
		}else if(data.type=="copy_selection"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			copySelection(c.peer);
		}else if(data.type=="paste_selection"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			pasteSelection(c.peer);
		}else if(data.type=="select_paste"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			commitHistory(c.peer);
			selectPasteClip(c.peer);
		}else if(data.type=="select_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			peerhistory[0].selectionclip = {x:0,y:0,x2:0,y2:0,w:0,h:0};
			selectClearClip(c.peer);
		}else if(data.type=="clip_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			//commitHistory(c.peer);
			peerhistory[0].selectionclipcontext.clearRect(0, 0, peerhistory[0].selectionclipcanvas.width, peerhistory[0].selectionclipcanvas.height);
			peerhistory[0].selectionclipped = false;
		}else if(data.type=="select_clip"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			commitHistory(c.peer);
			
			//if clearing section, keep backup of what was there so we can pass to historylist(so we can restore it).
			var backupcanvas = document.createElement("canvas");
			backupcanvas.width = project.width;
			backupcanvas.height = project.height;
			var backupcontext = backupcanvas.getContext("2d");
			backupcontext.drawImage(project.canvaslayer[data.frame],0,0);
						
			selectClip(c.peer);
			if(data.selecttype=="cut"){
				peerhistory[0].context.drawImage(peerhistory[0].selectionclipcanvas,peerhistory[0].selectionoffset.x,peerhistory[0].selectionoffset.y);
				
				claimHistory(c.peer,peerhistory[0].canvas);
				peerhistory[0].layers.push(new historylayerdata("",peerhistory[0].canvas,peerhistory[0],true,backupcanvas) );
				project.contextlayer[data.frame].globalCompositeOperation = 'destination-out';
				project.contextlayer[data.frame].drawImage(peerhistory[0].canvas,0,0);
				project.contextlayer[data.frame].globalCompositeOperation = 'source-over';
			}else{
				peerhistory[0].context.drawImage(peerhistory[0].selectionclipcanvas,peerhistory[0].selectionoffset.x,peerhistory[0].selectionoffset.y);
				
				claimHistory(c.peer,peerhistory[0].canvas);
				peerhistory[0].layers.push(new historylayerdata("",peerhistory[0].canvas,peerhistory[0],true,backupcanvas) );
				project.contextlayer[data.frame].drawImage(peerhistory[0].canvas,0,0);
			}
			peerhistory[0].context.clearRect(0, 0, peerhistory[0].canvas.width, peerhistory[0].canvas.height);
							
		}else if(data.type=="resize_clip"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			peerhistory[0].selectionoffset = data.offset;
			peerhistory[0].selectionclip = data.clip;
			peerhistory[0].resize = data.resize;
			peerhistory[0].selectionhandle = data.handle;
			resizeClip(c.peer,(peerhistory[0].resize.alt ? true : false) );
		}else if(data.type=="refresh_clip"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].frame = data.frame;
			peerhistory[0].selectionclip = data.clip;
			selectClip(c.peer,true);
		}else if(data.type=="history_select"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			if(peerhistory.length==1)
				peerhistory[0].selected = data.num;
		}else if(data.type=="history_clear"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			//peerhistory[0].selected = data.num;
			commitHistory(peerhistory[0].id);
			clearHistory(peerhistory[0].id);
			peerhistory[0].layers.push(new historylayerdata("New",peerhistory[0].canvas,peerhistory[0]) );
		}else if(data.type=="remove_frame"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			removeFrame(data.frame);
		}else if(data.type=="add_frame"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			addFrame(data.frame);
		}else if(data.type=="order_frames"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			data.order.forEach(function(entry){
				//$('#frame_'+entry).append( $("#frame_list") );
				$("#frame_list").append( $('#frame_'+entry) );
			});
		}else if(data.type=="frame_interval"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			$('#frame_null').siblings('[value="'+data.frame+'"]').attr('data-interval',data.interval);
			$('#frame_null').siblings('[value="'+data.frame+'"]').find('.frame_interval').html(data.interval*0.001);
		}else if(data.type=="toggle_visible"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			project.visible[data.frame] = data.visible;
			$('#frame_null').siblings('[value="'+data.frame+'"]').find('.frame_visible').attr('src',(data.visible!=true?'eye-shut.png':'eye-open.png'));
		}else if(data.type=="toggle_linked"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			$('#frame_null').siblings('[value="'+data.frame+'"]').find('.frame_linker').css('background-image','url(icon-'+(data.linked==false?'un':'')+'linked.png)');
		}else if(data.type=="frame_opacity"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			project.opacity[data.frame] = data.opacity;
		}else if(data.type=="resize_image"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			resizeImage(data.width,data.height );
		}else if(data.type=="resize_canvas"){
			//var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			resizeCanvas(data.width,data.height,data.direction );
		}else if(data.type=="start_rotation"){
		
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			peerhistory[0].rotation = data.rotation;
			peerhistory[0].selectionclip = data.clip;
			peerhistory[0].selectionmaskcontext.clearRect(0,0,peerhistory[0].selectionmaskcanvas.width,peerhistory[0].selectionmaskcanvas.height);
			startRotate(peerhistory[0].id,c.peer,data.center);
		}else if(data.type=="unlock_rotation"){
			myHistory[0].rotatedPeers++;
			//console.log(peerlist.length+","+myHistory[0].rotatedPeers);
			if(myHistory[0].rotatedPeers >= peerlist.length){
				myHistory[0].rotation.state = 0;
				myHistory[0].rotatedPeers = 0;
				send_select_move(myHistory[0].selectionoffset);
			}
		}else if(data.type=="save_resize"){
			resizeLayers = new resizeLayersData();
			resizeLayers.getOrder();
			project.canvaslayer.forEach(function(entry){
				resizeLayers.layer.push(entry.toDataURL() );
			});
		}else if(data.type=="add_resize_undo"){
			addResizeUndo();
		}else if(data.type=="undo_resize"){
			revertResize();
		}else if(data.type=="load_clipart"){
			var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
			
			var img = new Image()
			img.onload = function(){
				peerhistory[0].selectionclipcontext.clearRect(0,0, peerhistory[0].selectionclipcanvas.width, peerhistory[0].selectionclipcanvas.height);
				peerhistory[0].selectionclipcanvas.width = this.width;
				peerhistory[0].selectionclipcanvas.height = this.height;
				peerhistory[0].selectionclipcontext.drawImage(this,0,0);
				peerhistory[0].selectionmaskcanvas.width = this.width;
				peerhistory[0].selectionmaskcanvas.height = this.height;
				
				selectClip(peerhistory[0].id);
				peerhistory[0].selectionclip.x = peerhistory[0].selectionoffset.x;
				peerhistory[0].selectionclip.y = peerhistory[0].selectionoffset.y;
				peerhistory[0].selectionhandle.state = 0;
				peerhistory[0].selectionstate = "";
				
				//send message back to clipart originator
				var conns = peer.connections[c.peer];
				for (var i = 0, ii = conns.length; i < ii; i += 1) {
					var conn = conns[i];
				  
					if(connlist.indexOf(conn.id)!=-1 && conn.label=='draw'){
						var msg = {type:'unlock_waiting' };
						conn.send( msg );
					}
				}
			};
			img.src = data.clipart;
			
		}else if(data.type=="unlock_waiting"){
			project.waiting++;
			if(project.waiting >= peerlist.length){
				project.wait = false;
				project.waiting = 0;
				send_select_move(myHistory[0].selectionoffset);
			}
		}
		
		
		
							
		
	});
		
		
    c.on('close', function() {
	  //alert(c.peer + ' has left the session.');
	  $('#msgbox').append('<div style="direction:ltr;"><span class="peer">' + c.peer + '</span>' + ' has left the session.' +
			'</div>');
		//chatbox.remove();
	  //if ($('.connection').length === 0) {
	  //  $('.filler').show();
	  //}
	  //delete connectedPeers[c.peer];
	  peerlist.splice(peerlist.indexOf(c.peer),1);
	  connlist.splice(connlist.indexOf(c.id),1);
	  var peerhistory = $.grep(historylist, function(e){ return e.id == c.peer; });
		if(peerhistory.length>0)historylist.splice(historylist.indexOf(peerhistory[0]),1);
	  var peerlayer = $.grep(brushlayers, function(e){ return e.id == c.peer; });
		if(peerlayer.length>0)brushlayers.splice(brushlayers.indexOf(peerlayer[0]),1);
		//alert(peerlist);
		userlist.innerHTML = '';

		peerlist.forEach(function(entry) {
			userlist.innerHTML = userlist.innerHTML + ' ' + entry;

		});
	});
	
  } else if (c.label === 'file') {
    c.on('data', function(data) {
      // If we're getting a file, create a URL for it.
      if (data.constructor === ArrayBuffer) {
        var dataView = new Uint8Array(data);
        var dataBlob = new Blob([dataView]);
        var url = window.URL.createObjectURL(dataBlob);
        $('#' + c.peer).find('.messages').append('<div><span class="file">' +
            c.peer + ' has sent you a <a target="_blank" href="' + url + '">file</a>.</span></div>');
      }
    });
  }
  
}

$(document).ready(function() {

	$( '.tooltip' ).tooltip({
		track: true
	});

	$( "input[type=submit], button" )
		.button()
		.click(function( event ) {
		event.preventDefault();
	})
	.css({
	  'font-size' : '10px'
	});
	
	$( "button").button().css({
		'font-family': '"Noto Serif", sans-serif',
		'text-shadow': '-1px -1px 0 #222222',
	});	
	$( "input[type=submit], button").not('.smallicon').button().css({
		'font-family': '"Noto Serif", sans-serif',
		'text-shadow': '-1px -1px 0 #222222',
		'font-size':'10px',
		'letter-spacing':'1px',
		'font-weight': 400
	});	
	
	$('input[type=text]').addClass("ui-corner-all").css({
          'font-size' : '12px',
		  'color':'#eeeeee',
          'background' : '#444444',
		  'border-width' : '1px',
		  'padding' : '3px',
		  'vertical-align':'middle'
	});
	
	$('#connect_room').css({
		'padding':'3px',
		'margin': '2px',
		'font-size':'10px',
		'-webkit-border-radius':'4px',
		'-moz-border-radius':'4px',
		'border-radius':'4px',
		
		'background': '#333333',
		'color':'#888',
		'border':'none',
		'outline':'none',
		'display': 'inline-block',
		'cursor':'pointer'
	});
	
	$( "#chat_toggle").button({
		text: false,
		icons: {
		primary: "ui-icon-carat-1-s"
		}
	}).click(function(){
		if( $( "#chat_toggle span:first" ).hasClass('ui-icon-carat-1-s') ){
			$( "#chat_toggle" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-carat-1-n" }
			});
			  $('#connect_box').hide();
			  $('#wacom_detect').hide();
		}else{
			$( "#chat_toggle" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-carat-1-s" }
			});
			if(typeof(peer) =='undefined'){
				$('#connect_box').show();
				if(typeof wacom == 'undefined' || typeof wacom.penAPI  == 'undefined')$("#wacom_detect").show();
			}
		}
		setAppSize();
	});
		
	$( ".pickertextbox" ).spinner({
		max: 256,
		min: -1,
		spin: function( event, ui ) {
			slider_or_spinner = false;
			max = $(this).spinner('option', 'max'),
			min = $(this).spinner('option', 'min');
			if ( ui.value > max-1 ) {
				$( this ).spinner( "value", 0 );
				refreshSwatch(0);
				return false;
			} else if ( ui.value < 0 ) {
				$( this ).spinner( "value", max-1 );
				refreshSwatch(0);
				return false;
			}
			refreshSwatch(0);
		},
		stop: function(){
			if(slider_or_spinner == false )refreshSwatch(0);
		}
	}).on('input', function () {
		var val = this.value,
		$this = $(this),
		max = $this.spinner('option', 'max'),
		min = $this.spinner('option', 'min');
		if (!val.match(/^\d+$/)) val = 0; //we want only number, no alpha
		this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
		slider_or_spinner = false;
	}).css({
		'border': 'show',
		'color': '#cccccc',
		'width':'32px',
		'height':'8px',
		'font-size':'12px'
	})
    .parent()
    //.find(".ui-widget ")
    .css({
		'border': 'none',
		'background': 'none',
		'font-size':'5px',
		'height':'17px'
	})
	.parent()
    .find(".ui-spinner-input ")
    .css({
		'border': 'solid 1px',
		'margin-top': '1px',
		'margin-right': '17px'
	});
	
	
	$( "#canvas_container" ).draggable({ handle: "span:first" });
	//$( "#colorpicker_container, #properties_container " )
	//.draggable({ handle: "span" , snap: "#canvas_container", snapMode: "outer" });
	
	$( "#canvas" ).resizable({
		stop: function(event, ui) {
			canvas.width = ui.size.width;
			canvas.height = ui.size.height;
			context = reload_canvas(canvas,context);
			//contextlayer = reload_canvas(canvaslayer,contextlayer);
		}
	});
	$( "#minicanvas_resizer" ).resizable({
		handles: { 'sw': $("#southwest")},
		resize:function(event, ui) {
			$( "#minicanvas" ).parent().css('left','0px');
			$( "#minicanvas" ).width(ui.size.width);
			$( "#minicanvas" ).height(ui.size.height);
		},
		stop: function(event, ui) {
			$( "#minicanvas" ).parent().css('left','0px');
			minicanvas.width = ui.size.width;
			minicanvas.height = ui.size.height;
			minicontext = reload_canvas(minicanvas,minicontext);
			if(typeof(Storage) !== 'undefined'){
				localStorage.minicanvas_width = JSON.stringify(ui.size.width);
				localStorage.minicanvas_height = JSON.stringify(ui.size.height);
			}
		}
	});
	//$('.ui-resizable-sw').addClass('ui-icon ui-resizable-southwest');

	$( "#red, #green, #blue" ).slider({
		orientation: "horizontal",
		range: "min",
		max: 255,
		value: 127,
		slide: function(){
			slider_or_spinner = true;
			if(slider_or_spinner == true  )refreshSwatch(1);
		},
		change: function(){
			if(slider_or_spinner == true  )refreshSwatch(1);
		}
	}).css({
		'margin':'0px',
		'padding':'2px',
		'width':'100px',
		'height':'10px'
	})
	.find('div').css({
		'border-radius':'0',
		'position':'static',
		'height':'8px',
		'margin-top':'1px',
		'overflow':'hidden'
	})
	.next().css({
		'width':'8px',
		'height':'9px',
		'top':'2px',
		'overflow':'hidden'
	});
	
	$( "#red" ).slider( "value", 255 );
	$( "#green" ).slider( "value", 140 );
	$( "#blue" ).slider( "value", 60 );
	
	$( "#rgb_hsl_radio" ).buttonset().css({
		'padding':'2px',
        'font-size' : '12px'
	}).children(':radio').click(function(e){
		if( $(this).next('label').attr('aria-pressed')=='true'){
			if($(this).attr("id")=="radio1"){
				var colorvalues;
				if(mouse.currentColor==0) colorvalues =  hslToRgb(mouse.hsl.h,mouse.hsl.s,mouse.hsl.l);
				else colorvalues =  hslToRgb(mouse.hsl2.h,mouse.hsl2.s,mouse.hsl2.l);
				colorvalues = useSafeColors(colorvalues);
				$( "#redvalue.pickertextbox, #greenvalue.pickertextbox, #bluevalue.pickertextbox" ).spinner( "option", "max", 256 );
				$( "#red, #green, #blue" ).slider( "option", "max", 255 );
				colorPickerMode = 'rgb';
				convertSwatch(colorPickerMode,colorvalues);
			}else{
				var colorvalues;
				if(mouse.currentColor==0) colorvalues = rgbToHsl(mouse.rgb.r,mouse.rgb.g,mouse.rgb.b);
				else colorvalues = rgbToHsl(mouse.rgb2.r,mouse.rgb2.g,mouse.rgb2.b);
				$( "#redvalue.pickertextbox" ).spinner( "option", "max", 361 );
				$( "#greenvalue.pickertextbox, #bluevalue.pickertextbox" ).spinner( "option", "max", 101 );
				$( "#red" ).slider( "option", "max", 360 );
				$( "#green, #blue" ).slider( "option", "max", 100  );
				colorPickerMode = 'hsl';
				convertSwatch(colorPickerMode,colorvalues );
			}
			//$(this).attr('checked', true);
		}
	});
	$( "#rgb_hsl_radio" ).find('.ui-button-text').click(function(){$(this).parent().click();}).css('user-select', 'none').css({'padding':'0px 4px 0px 4px'});

	$( "#load_colordex" ).button({
		text: false,
		icons: {
		primary: "ui-icon-folder-open"
		}
	}).click(function(){
		$('#file_load_colordex').click();
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#save_colordex" ).button({
		text: false,
		icons: {
		primary: "ui-icon-disk"
		}
	}).click(function(){
		$("#popup_title").html('Save Colordex');
		$("#popup_content").html('<div id="colordex_save_dialog">\
			<p>Specify the filename.</p>\
			Filename:<input type="text" id="colordex_save_dialog_name" ><br>\
			</div>');
		$("#popup_container").show();
		$("#popup_title").show();
		$("#popup_submit").unbind( "click" );
		$("#popup_submit").click(function(){
			saveColordex($('#colordex_save_dialog_name').val() );
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
		$("#popup_cancel").unbind( "click" );
		$("#popup_cancel").click(function(){
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#lock_colordex" ).button({
		text: false,
		icons: {
		primary: "ui-icon-unlocked"
		}
	}).click(function(){
		$( "#lock_colordex" ).button('refresh');
		if( $(this).next('label').attr('aria-pressed')=='true'){
			$( "#lock_colordex" ).button("option", {
				icons: { primary: "ui-icon-locked" }
			}).next('label').attr('title','Unlock').css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
			tool.lockcolordex = true;
		}else{
			$( "#lock_colordex" ).button("option", {
				icons: { primary: "ui-icon-unlocked" }
			}).next('label').attr('title','Lock').css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
			tool.lockcolordex = false;
		}
	}).attr('checked', false).button('refresh').next('label').css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#colordex_radio" ).button().prop('checked',false).click(function(){
		if(typeof(Storage) !== "undefined") localStorage.colordex = ($(this).next('label').attr('aria-pressed')=='true'?'false':'true'); 
		$( "#colordex_container" ).toggle("blind");
		if( $(this).next('label').attr('aria-pressed')=='true'){
			
			//$(this).attr('checked', false);
		}
	}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
        'font-size' : '12px'});
	if(typeof(Storage) !== "undefined" && localStorage.colordex=='true')$( "#colordex_radio" ).prop('checked',false).click();
	
	$( "#palette_radio" ).button().prop('checked',false).click(function(){
		if(typeof(Storage) !== "undefined") localStorage.palettetoggle = ($(this).next('label').attr('aria-pressed')=='true'?'false':'true');
		$( "#palette_bounds" ).width( $( "#canvas" ).width() - $( "#colorpicker_container" ).width() );
		$( "#palette_container" ).toggle("blind", {"direction": "left"});
		if( $(this).next('label').attr('aria-pressed')=='true'){
			//$(this).attr('checked', false);
		}
	}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
        'font-size' : '12px'});
	if(typeof(Storage) !== "undefined" && localStorage.palettetoggle=='true')$( "#palette_radio" ).prop('checked',false).click();
	
	$( "#scan_palette" ).button().click(function(){
		if(typeof(tool.colorscan) !== "undefined") tool.colorscan.terminate();
		colorScan();
	});
	
	$( "#contiguous" ).button().prop('checked',false).click(function(){
		if(typeof(Storage) !== "undefined") localStorage.contiguous = ($(this).next('label').attr('aria-pressed')=='true'?'false':'true');//JSON.stringify($(this).attr('checkbox')) ; 
		if( $(this).next('label').attr('aria-pressed')){
		}
	}).next().find('.ui-button-text').css({'padding':'0px 4px 0px 4px',
        'font-size' : '12px'});
	if(typeof(Storage) !== "undefined" && localStorage.contiguous=='true')$( "#contiguous" ).prop('checked',false).click();
	
	$( "#brush_presets" ).buttonset().css({
		'padding':'2px',
        'font-size' : '12px'
	}).children().click(function(){
		$(this).siblings('input').attr('checked',false);
		$(this).attr('checked',true);
		$( "#brush_presets" ).buttonset('refresh');
		if( $(this).next('label').attr('aria-pressed')=='true'){
			//tool.size = tool.preset[$(this).attr("value")].size;
			//tool.opacity = tool.preset[$(this).attr("value")].opacity;
			//tool.hardness = tool.preset[$(this).attr("value")].hardness;
			//tool.levels = tool.preset[$(this).attr("value")].levels;
			tool.pen = tool.preset[$(this).attr("value")].pen;
			$("#tool_size").slider('value',tool.preset[$(this).attr("value")].size);
			$("#tool_opacity").slider('value',tool.preset[$(this).attr("value")].opacity);
			$("#tool_hardness").slider('value',tool.preset[$(this).attr("value")].hardness);
			$("#tool_levels").slider('value',tool.preset[$(this).attr("value")].levels);
			$("#pencontrol_size").attr("title",(tool.pen.s=="pressure"?"Pen Pressure":tool.pen.s=="tilt"?"Pen Tilt":tool.pen.s=="direction"?"Pen Direction":"None") ).css("background-image","url(icon-"+(tool.pen.s=="pressure"?"pressure":tool.pen.s=="tilt"?"tilt":tool.pen.s=="direction"?"direction":"none") +".png)");
			$("#pencontrol_opacity").attr("title",(tool.pen.o=="pressure"?"Pen Pressure":tool.pen.o=="tilt"?"Pen Tilt":tool.pen.o=="direction"?"Pen Direction":"None") ).css("background-image","url(icon-"+(tool.pen.o=="pressure"?"pressure":tool.pen.o=="tilt"?"tilt":tool.pen.o=="direction"?"direction":"none") +".png)");
			$("#pencontrol_hardness").attr("title",(tool.pen.h=="pressure"?"Pen Pressure":tool.pen.h=="tilt"?"Pen Tilt":tool.pen.h=="direction"?"Pen Direction":"None") ).css("background-image","url(icon-"+(tool.pen.h=="pressure"?"pressure":tool.pen.h=="tilt"?"tilt":tool.pen.h=="direction"?"direction":"none") +".png)");
			$("#pencontrol_levels").attr("title",(tool.pen.l=="pressure"?"Pen Pressure":tool.pen.l=="tilt"?"Pen Tilt":tool.pen.l=="direction"?"Pen Direction":"None") ).css("background-image","url(icon-"+(tool.pen.l=="pressure"?"pressure":tool.pen.l=="tilt"?"tilt":tool.pen.l=="direction"?"direction":"none") +".png)");
			
		}
	}).next('label').removeClass('ui-state-active').children('.ui-button-text').css({'padding':'0px 4px 0px 4px'});
	$( "#preset1" ).next('label').attr('aria-pressed',true);
	
	//toolbar
	$( "#toolbar" ).buttonset().css('margin-right',0).draggable().find('button').click(function(e){
		if(approveContinue()){	//helps keep peers in sync
			$( "#toolbar" ).buttonset().find('button').button( "option", "disabled", false ).removeClass('ui-state-focus');
		   // $(this).button( "option", "disabled", true );
			//$(this).unbind('onblur onchange onfocus onclick onmouseout onmouseup onkeypress onkeydown onkeyup');
			$(this).removeClass('ui-button-disabled ui-state-disabled');
			$(this).addClass('ui-state-hover ui-state-focus');
			mouse.tool = $(this).attr("id");
			if(mouse.tool=='pencil')$( "#pencil" ).attr('value',0);
			else if(mouse.tool=='brush')$( "#pencil" ).attr('value',1);
			if(mouse.tool=='eraser')$( "#eraser" ).attr('value',0);
			else if(mouse.tool=='magiceraser')$( "#eraser" ).attr('value',1);
			//make sure to paste clipped image if we're selecting a nonselection tool
			if( (mouse.tool == 'eraser' || mouse.tool == 'magiceraser' || mouse.tool == 'pencil' || mouse.tool == 'brush' || mouse.tool == 'bucket' ) && myHistory[0].selectionclipped==true){
				commitHistory(myHistory[0].id);
				selectPasteClip(myHistory[0].id);
				send_select_paste();
				selectClearClip(myHistory[0].id);
				send_select_clear();
				//make sure selection is not selecting anything
				myHistory[0].selectionpoints.push( {x:0,y:0} );
				myHistory[0].selectionclip.x = 0, myHistory[0].selectionclip.y = 0;
				myHistory[0].selectionclip.x2 = 0, myHistory[0].selectionclip.y2 = 0;
			}
			if(mouse.tool == 'eraser' || mouse.tool == 'magiceraser' || mouse.tool == 'pencil' || mouse.tool == 'brush'){
				$("#brush_settings").show();
				$("#bucket_settings").hide();
			}
			if(mouse.tool == 'bucket' || mouse.tool == 'magicwand' ){
				$("#bucket_settings").show();
				$("#brush_settings").hide();
			}
		}
	}).blur(function(){
		$(this).addClass('ui-state-hover ui-state-focus');
	});
	$( "#toolbar" ).find('button').css({
		'margin':'2px'
	});
	$( "#pencil, #brush, #bucket, #eraser, #lasso, #marquee, #magicwand" ).button({
		text: false,
		icons: {
		primary: "ui-icon-seek-start"
		}
	});

	loadIconsOnButtons('toolbar');
	$("#bucket_settings").hide();
	
	$( "#menu_icons button" ).button({
		text: false,
		icons: {
		primary: "ui-icon-gear"
		}
	});
	$( "#menu_icons_img input").click(function(){
		$( this ).button('refresh');
		project.grid.show = ($(this).next('label').attr('aria-pressed')=='true'?true:false);
		if(typeof(Storage) !== "undefined") localStorage.grid = JSON.stringify(project.grid);
	}).next('label').css({
		'font-size':'10px',
		'width':'',
		'padding':'0px'
	});
	
	$( "#settings").click(function(){
			$("#menu_edit_list li[name='settings']").click();
	});
	loadIconsOnButtons('menu_icons_img');
	
	if(typeof(Storage) !== "undefined" && checkJSON('grid')!=null )project.grid = JSON.parse(localStorage.grid);
	if(project.grid.show==true){
		$( "#grid").attr('checked',true).next('label').addClass('ui-state-active').attr('aria-pressed',true);
		$( "#grid").button('refresh');
	}else{
		$( "#grid" ).next('label').removeClass('ui-state-active').attr('aria-pressed','false');
		$( "#grid").button('refresh');
	}
	
	$("#playback_slider").slider( {
		orientation: "horizontal",
		range: "min",
		max: 255,
		value: 127,
		disabled:false 
	}).css({
		'border-radius':'0',
		'margin':'2px',
		'padding':'2px',
		'height':'5px'
	})
	.find('div').css({
		'border-radius':'0',
		'height':'4px',
		'margin-top':'1px',
		'overflow':'hidden'
	})
	.next().css({
		'width':'8px',
		'height':'9px',
		'top':'0px',
		'overflow':'hidden'
	});
	
	$( "#playback_start" ).button({
		text: false,
		icons: {
		primary: "ui-icon-seek-start"
		}
	})
	.click(function() {
		project.playback.session=0;
		project.playback.action = 0;
		project.playback.stop();
		$("#playback_slider").slider('value',project.playback.keyframe[project.playback.session]);
		project.recording.session[project.playback.session].canvasdata.forEach(function(entry){
			var img = new Image()
			img.onload = function(){
				project.contextlayer[project.recording.session[project.playback.session].canvasdata.indexOf(entry)].clearRect(0,0, project.width, project.height);
				project.contextlayer[project.recording.session[project.playback.session].canvasdata.indexOf(entry)].drawImage(this,0,0);
			};
			img.src = entry;
		});
		if(project.recording.session[project.playback.session].canvasdata.length==0){
			project.contextlayer.forEach(function(entry){
				entry.clearRect(0,0, project.width, project.height);
			});
		}
	})
	.next().button({
		text: false,
		icons: {
		primary: "ui-icon-seek-prev"
		}
	})
	.click(function() {
		if(project.playback.session>0){
			project.playback.session--;
			project.playback.action = 0;
			$("#playback_slider").slider('value',project.playback.keyframe[project.playback.session]);
		}
	})
	.next().button({
		text: false,
		icons: {
		primary: "ui-icon-play"
		}
	})
	.click(function(event,ui) {
		if( $( this ).find('span:first').hasClass('ui-icon-play') ){
			$( this ).button("option", {
				text: false,
				icons: { primary: "ui-icon-pause" }
			});
			//project.playback.action = 0;
			if(project.playback.state==false)project.playback.start();
		}else{
			$( this ).button("option", {
				text: false,
				icons: { primary: "ui-icon-play" }
			});
			if(project.playback.state==true)project.playback.stop();
		}
	})
	.next().button({
		text: false,
		icons: {
		primary: "ui-icon-stop"
		}
	})
	.click(function() {
		if(project.playback.state==true){
			project.playback.action=0; 
			project.playback.stop();
			$("#playback_slider").slider('value',project.playback.keyframe[project.playback.session]);
			$( this ).prev().button("option", {
				text: false,
				icons: { primary: "ui-icon-play" }
			});
		}
	})
	.next().button({
		text: false,
		icons: {
		primary: "ui-icon-seek-next"
		}
	})
	.click(function() {
		if(project.playback.session<project.recording.session.length-1){
			project.playback.session++;
			project.playback.action = 0;
			$("#playback_slider").slider('value',project.playback.keyframe[project.playback.session]);
		}
	})
	.next().button({
		text: false,
		icons: {
		primary: "ui-icon-seek-end"
		}
	})
	.click(function() {
		project.playback.session=project.recording.session.length-1;
		project.playback.action = project.recording.session[project.playback.session].actionlist.length;
		project.playback.stop();
		$("#playback_slider").slider('value',project.playback.keyframe[project.playback.session]+project.recording.session[project.playback.session].actionlist.length);
		project.playback.canvasdata.forEach(function(entry){
			var img = new Image()
			img.onload = function(){
				project.contextlayer[project.playback.canvasdata.indexOf(entry)].clearRect(0,0, project.width, project.height);
				project.contextlayer[project.playback.canvasdata.indexOf(entry)].drawImage(this,0,0);
			};
			img.src = entry;
		});
		
	}).parent().buttonset();
	
	$( "#playback_speed" ).spinner({
		max: 1001,	
		min: -1,	
		spin: function( event, ui ) {
			project.playback.speed = $(this).spinner('value');
		},
		change: function(){
			project.playback.speed = $(this).spinner('value');
		}
	}).on('input', function () {
		var val = this.value,
		$this = $(this),
		max = $this.spinner('option', 'max'),
		min = $this.spinner('option', 'min');
		if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
		this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
		slider_or_spinner = false;
	})
	$( "#playback_container" ).hide();
	$( "#record_container" ).hide();
	
	$( "#record_progressbar" ).progressbar({value:0});
	
	$( "#record_speed" ).spinner({
		max: 10001,	
		min: 0,	
		spin: function( event, ui ) {
			max = $(this).spinner('option', 'max'),
			min = $(this).spinner('option', 'min');
			/*if ( ui.value > max-1 ) {
				$( this ).spinner( "value", min+1 );
				return false;
			} else if ( ui.value < min+1 ) {
				$( this ).spinner( "value", max-1 );
				return false;
			}*/
			//project.playback.speed = $(this).spinner('value');
		},
		change: function(){
			//project.playback.speed = $(this).spinner('value');
		}
	}).spinner('value',200).on('input', function () {
		var val = this.value,
		$this = $(this),
		max = $this.spinner('option', 'max'),
		min = $this.spinner('option', 'min');
		if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
		this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
		//slider_or_spinner = false;
	});
	
	$( "#record_keyframe" ).spinner({
		max: 1001,	
		min: 1,	
		spin: function( event, ui ) {
			max = $(this).spinner('option', 'max'),
			min = $(this).spinner('option', 'min');
			/*if ( ui.value > max-1 ) {
				$( this ).spinner( "value", min+1 );
				return false;
			} else if ( ui.value < min+1 ) {
				$( this ).spinner( "value", max-1 );
				return false;
			}*/
			//project.playback.speed = $(this).spinner('value');
		},
		change: function(){
			//project.playback.speed = $(this).spinner('value');
		}
	}).spinner('value',5).on('input', function () {
		var val = this.value,
		$this = $(this),
		max = $this.spinner('option', 'max'),
		min = $this.spinner('option', 'min');
		if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
		this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
		//slider_or_spinner = false;
	});
	
	$( ".recordspinner" ).spinner().css({
		'border': 'show',
		'color': '#cccccc',
		'width':'32px',
		'height':'10px',
		'font-size':'12px'
	}).parent().css({
		'border': 'none',
		'background': 'none',
		'font-size':'5px',
		'height':'20px'
	}).parent().find(".ui-spinner-input ").css({
		'border': 'solid 1px',
		'margin-top': '1px',
		'margin-right': '17px'
	});
	
	$( "#record_button" ).button({text:true}).attr('checked',false).button('refresh').click(function(){
		$( this ).button('refresh');
		 $(this).next('label').text(this.checked ? "On" : "Off");
	}).next('label').attr('aria-pressed',true).css('width','24px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
	
	$( "#record_reset" ).button().click(function(){
		project.playback.gif=null;
		$("#record_count").html(0);
	}).css('width','40px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
	$( "#record_save" ).button({
		text: false,
		icons: {
		primary: "ui-icon-disk"
		}
	}).click(function(){
		exportPlaybackGif( $('#filename').val() );
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
	$('#record_scale').css({
		'padding':'3px',
		'margin': 0,
		'font-size':'12px',
		'-webkit-border-radius':'4px',
		'-moz-border-radius':'4px',
		'border-radius':'4px',
		
		'background': '#333333',
		'color':'#888',
		'border':'none',
		'outline':'none',
		'display': 'inline-block',
		'cursor':'pointer'
	});
	$( "#record_settings" ).button({
		text: false,
		icons: {
		primary: "ui-icon-gear"
		}
	}).click(function(){
		$("#popup_title").html('Record Settings');
		$("#popup_content").html('<div id="record_settings_dialog">\
			Set the area of the image to be recorded.<br>\
			Width:<input type="text" class="record_dialog_spinner" id="record_dialog_x" value="'+project.playback.crop.x+'" ><br>\
			Height:<input type="text" class="record_dialog_spinner" id="record_dialog_y" value="'+project.playback.crop.y+'" ><br>\
			Width:<input type="text" class="record_dialog_spinner" id="record_dialog_width" value="'+project.playback.crop.w+'" ><br>\
			Height:<input type="text" class="record_dialog_spinner" id="record_dialog_height" value="'+project.playback.crop.h+'" ><br>\
			</div>');
		$("#popup_container").show();
		$("#popup_title").show();
		$("#popup_submit").unbind( "click" );
		$("#popup_submit").click(function(){
			project.playback.crop.x = $("#record_dialog_x").spinner("value");
			project.playback.crop.y = $("#record_dialog_y").spinner("value");
			project.playback.crop.w = $("#record_dialog_width").spinner("value");
			project.playback.crop.h = $("#record_dialog_height").spinner("value");
			$("#popup_container").hide();	
			$("#popup_title").hide();							
		});
		$("#popup_cancel").unbind( "click" );
		$("#popup_cancel").click(function(){
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
		
		$( ".record_dialog_spinner" ).spinner({
			max: project.width,	//canvas size limit is 8192 pixels I think, but we don't need all those..
			min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
			spin: function( event, ui ) {
				slider_or_spinner = false;
				max = $(this).spinner('option', 'max'),
				min = $(this).spinner('option', 'min');
				if ( ui.value > max-1 ) {
					$( this ).spinner( "value", min+1 );
					return false;
				} else if ( ui.value < min+1 ) {
					$( this ).spinner( "value", max-1 );
					return false;
				}
			},
			change: function(){
				if(slider_or_spinner == false ){}
			}
		}).each(function(){ $(this).spinner('option', 'max', project.width ); })
		.on('input', function () {
			var val = this.value,
			$this = $(this),
			max = $this.spinner('option', 'max'),
			min = $this.spinner('option', 'min');
			if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
			this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
			slider_or_spinner = false;
		});
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
	
	$( "#tool_size, #tool_opacity, #tool_hardness, #tool_levels" ).slider({
		orientation: "horizontal",
		range: "min",
		max: 255,
		value: 10,
		slide: function( e,ui ){
			var num = $("#brush_presets input:checked").attr('value');
			if(typeof num === 'undefined')num=1;
			if($(this).attr("id")=="tool_size"){tool.size = ui.value; tool.preset[num].size = tool.size;}
			else if($(this).attr("id")=="tool_opacity"){tool.opacity = ui.value; tool.preset[num].opacity = tool.opacity;}
			else if($(this).attr("id")=="tool_hardness"){tool.hardness = ui.value; tool.preset[num].hardness = tool.hardness;}
			else if($(this).attr("id")=="tool_levels"){tool.levels = ui.value; tool.preset[num].levels = tool.levels;}
			
			refreshTool(tool);
		},
		change: function(){
			var num = $("#brush_presets input:checked").attr('value');
			if(typeof num === 'undefined')num=1;
			if($(this).attr("id")=="tool_size"){tool.size = $(this).slider("option", "value"); tool.preset[num].size = tool.size;}
			else if($(this).attr("id")=="tool_opacity"){tool.opacity = $(this).slider("option", "value"); tool.preset[num].opacity = tool.opacity;}
			else if($(this).attr("id")=="tool_hardness"){tool.hardness = $(this).slider("option", "value"); tool.preset[num].hardness = tool.hardness;}
			else if($(this).attr("id")=="tool_levels"){tool.levels = $(this).slider("option", "value"); tool.preset[num].levels = tool.levels;}
			
			refreshTool(tool);
		},
		stop: function(){
			if(typeof(Storage) !== "undefined") localStorage.brushpreset = JSON.stringify(tool.preset) ; 
		}
	}).css({
		'margin':'2px',
		'padding':'2px',
		'width':'100px',
		'height':'10px'
	})
	.find('div').css({
		'border-radius':'0',
		'position':'static',
		'height':'8px',
		'margin-top':'1px',
		'overflow':'hidden'
	})
	.next().css({
		'width':'8px',
		'height':'9px',
		'top':'2px',
		'overflow':'hidden'
	});
	
	$( "#tool_size" ).slider({
		step: 0.5,
		min: 0.5,
		max: 100,
		value: tool.preset[1].size
	});	
	$( "#tool_opacity" ).slider({
		min: 0,
		max: 255,
		value: tool.preset[1].opacity
	});
	$( "#tool_hardness" ).slider({
		min: 1,
		max: 20,
		value: tool.preset[1].hardness
	});
	$( "#tool_levels" ).slider({
		min: 1,
		max: 10,
		value: tool.preset[1].levels
	});
	
	$("#pencontrol_size, #pencontrol_opacity, #pencontrol_hardness, #pencontrol_levels").button({
		text: false,
		icons: {
		primary: "ui-icon-seek-start"
		}
	}).click(function(){
		var num = $("#brush_presets input:checked").attr('value');
		if($(this).attr("title")=="None"){
			if($(this).attr("id")=="pencontrol_size")tool.pen.s="pressure"; 
			if($(this).attr("id")=="pencontrol_opacity")tool.pen.o="pressure"; 
			if($(this).attr("id")=="pencontrol_hardness")tool.pen.h="pressure"; 
			if($(this).attr("id")=="pencontrol_levels")tool.pen.l="pressure"; 
			$(this).attr("title","Pen Pressure").css("background-image","url(icon-pressure.png)");
		}
		else if($(this).attr("title")=="Pen Pressure"){
			if($(this).attr("id")=="pencontrol_size")tool.pen.s="tilt"; 
			if($(this).attr("id")=="pencontrol_opacity")tool.pen.o="tilt"; 
			if($(this).attr("id")=="pencontrol_hardness")tool.pen.h="tilt"; 
			if($(this).attr("id")=="pencontrol_levels")tool.pen.l="tilt"; 
			$(this).attr("title","Pen Tilt").css("background-image","url(icon-tilt.png)");
		}
		else if($(this).attr("title")=="Pen Tilt"){
			if($(this).attr("id")=="pencontrol_size")tool.pen.s="direction"; 
			if($(this).attr("id")=="pencontrol_opacity")tool.pen.o="direction"; 
			if($(this).attr("id")=="pencontrol_hardness")tool.pen.h="direction"; 
			if($(this).attr("id")=="pencontrol_levels")tool.pen.l="direction"; 
			$(this).attr("title","Pen Direction").css("background-image","url(icon-direction.png)");
		}
		else if($(this).attr("title")=="Pen Direction"){
			if($(this).attr("id")=="pencontrol_size")tool.pen.s="none"; 
			if($(this).attr("id")=="pencontrol_opacity")tool.pen.o="none"; 
			if($(this).attr("id")=="pencontrol_hardness")tool.pen.h="none"; 
			if($(this).attr("id")=="pencontrol_levels")tool.pen.l="none"; 
			$(this).attr("title","None").css("background-image","url(icon-none.png)");
		}
		tool.preset[num].pen = tool.pen;
		if(typeof(Storage) !== "undefined") localStorage.brushpreset = JSON.stringify(tool.preset) ; 
		
	});
	loadIconsOnButtons("pencontrols");
	$("#pencontrol_size").attr("title",(tool.preset[1].pen.s=='none'?"None":(tool.preset[1].pen.s=='pressure'?'Pren Pressure':(tool.preset[1].pen.s=='tilt'?'Pen Tilt':'Pen Direction'))) ).css("background-image","url(icon-"+tool.preset[1].pen.s+".png)");
	$("#pencontrol_opacity").attr("title",(tool.preset[1].pen.o=='none'?"None":(tool.preset[1].pen.o=='pressure'?'Pren Pressure':(tool.preset[1].pen.o=='tilt'?'Pen Tilt':'Pen Direction'))) ).css("background-image","url(icon-"+tool.preset[1].pen.o+".png)");
	$("#pencontrol_hardness").attr("title",(tool.preset[1].pen.h=='none'?"None":(tool.preset[1].pen.h=='pressure'?'Pren Pressure':(tool.preset[1].pen.h=='tilt'?'Pen Tilt':'Pen Direction'))) ).css("background-image","url(icon-"+tool.preset[1].pen.h+".png)");
	$("#pencontrol_levels").attr("title",(tool.preset[1].pen.l=='none'?"None":(tool.preset[1].pen.l=='pressure'?'Pren Pressure':(tool.preset[1].pen.l=='tilt'?'Pen Tilt':'Pen Direction'))) ).css("background-image","url(icon-"+tool.preset[1].pen.l+".png)");
	 
	$( "#frame_list" ).sortable({
		handle: ".handle",
		placeholder: 'ui-state-highlight',
		connectWith: '.connectedList',
		dropOnEmpty: true,
		'start': function (event, ui) {
			$('#frame_list').children('.ui-selected, .ui-state-hover').hide();
			//var selected = $('#frame_list').children(':has(.ui-selected)');
			//$(ui.item[0]).replaceWith(selected);
			//var clone = $(ui.item[0].outerHTML).clone();
			ui.placeholder.css({
				'margin': '1px',
				'padding': '2px',
				'display':'inline-block',
				'vertical-align':'top',
				'width':'48px',
				'height':'48px'
			});
		},
		sort: function(event,ui){
			$('#frame_list').attr('data-droploc', $('#frame_null').siblings(':visible').index($(ui.placeholder))+$(ui.helper).find('li.ui-state-hover').index() );
		},
		beforeStop: function(event,ui){
		     $('#frame_list').children('.ui-selected, .ui-state-hover').show().insertAfter($(ui.placeholder));
			//$(this).sortable('cancel');
			//$(ui.helper).children().insertAfter($(ui.placeholder));
		},
		stop: function(event,ui){
			$(ui.item).insertAfter($("#frame_null").siblings(':eq('+$('#frame_list').attr('data-droploc')+')') );
			$(ui.item).css({width:48,height:48});
			var sortarray = $(this).sortable('toArray', {attribute: 'value'});
			sortarray.shift();
			sortarray = sortarray.map(function (x) { 
				return parseInt(x, 10); 
			});
			send_frame_order(sortarray);
		},
        helper: function (event, ui) {
            var selected = $('#frame_list').children('.ui-selected, .ui-state-hover').clone();
			return $('<div id="helper"></div>').append(selected);
        }
	}).selectable({ 
		filter: "li", 
		cancel: ".handle, img, .frame_linker, .frame_interval",
		selecting : function(event,ui){
			$(ui.selecting).siblings().removeClass('ui-state-active');
			$(ui.selecting).toggleClass('ui-state-active');
			if(project.currentframe != $(ui.selecting).attr('value') ){
				project.currentframe = $(ui.selecting).attr('value');
				$("#frame_transparency").slider('value',project.opacity[project.currentframe]);
				if(project.playback.state==false){
					myHistory[0].frame = project.currentframe;
					myBrush[0].frame = project.currentframe;
				}
			}
		}
	}).css({
		'list-style-type': 'none',
		'margin': 0,
		'padding': 0
	}).children().hover(
		function () {
			$(this).addClass('ui-state-hover');
		}, 
		function () {
			$(this).removeClass('ui-state-hover');
		}
	).click(
		function(ui){
			$(this).siblings().removeClass('ui-state-active');
			if($(this).hasClass('ui-state-active')==false)$(this).toggleClass('ui-state-active');
			project.currentframe = $(this).attr('value');
			$("#frame_transparency").slider('value',project.opacity[project.currentframe]);
			if(project.playback.state==false){
				myHistory[0].frame = project.currentframe;
				myBrush[0].frame = project.currentframe;
			}
			//send_history_select(myHistory[0].selected);
		}
	).css({
		'margin': '1px',
		'padding': '2px',
		'position':'relative',
		'display' : 'inline-block',
		'vertical-align': 'top',
		'width' : '48px',
		'height' : '48px',
		'font-size': '14px'
	}).first().hide();
	
	$("#frame_transparency").slider({
		orientation: "horizontal",
		range: "min",
		max: 1,
		min: 0,
		step: 0.01,
		value: 1,
		stop: function(event,ui){
			project.opacity[project.currentframe] = ui.value;
			send_frame_opacity(project.currentframe,ui.value );
			//if(typeof(Storage) !== "undefined") localStorage.brushpreset = JSON.stringify(tool.preset) ; 
		}
	}).css({'margin':'4px'});
		
	$(" #history_container, #frame_container" )
	.draggable({ handle: "span:first" , snap: "#canvas_container", snapMode: "outer" ,
		start : function(event, ui) {
			if($(event.target).parent().is('.ui-droppable')){
				var height = $(event.target).find('.my-container').height();
				var x = ($(this).offset().left);
				var y = ($(this).offset().top);
				var p = $(event.target).parent().parent();
				$(event.target).detach().insertAfter(p).css('height','').width(90).css({'display':'table'}).find('.my-container').css({'height':height,'border':'solid 6px #333333'}).find('.resizer').show();
				$(event.target).find('.my-container').css('height','');
				if($(event.target).attr('id')=='frame_container')$("#frame_box").height(height);
				if($(event.target).attr('id')=='history_container')$("#history_box").height(height);
				$(ui.helper).css({'left':x-$(event.target).offset().left,'top':y-$(event.target).offset().top});
				//$(event.target).attr('value',event);
				/*var eventCopy = document.createEvent("MouseEvents");
				eventCopy.initMouseEvent(event.type, event.bubbles, event.cancelable, event.view, event.detail,
                event.pageX || event.layerX, event.pageY || event.layerY, event.clientX, event.clientY, event.ctrlKey, event.altKey,
                event.shiftKey, event.metaKey, event.button, event.relatedTarget);
				ui.dispatchEvent(eventCopy);*/
				return exception;
			}
		}
	});
	
	$( "#frame_container span[id='frame_resizer']" ).resizable({
		handles: 'se',
		minHeight:-1000,
		start: function(event, ui) {
			if($("#frame_orientation_toggle").attr('value')==1){
				$("#frame_box").attr('value',($("#frame_box").height() - ui.size.height));
			}
		},
		resize: function(event, ui) {
			if($("#frame_orientation_toggle").attr('value')==0){
				$("#frame_box").width(ui.size.width);
				$("#frame_list").width(project.frames*60);
				$("#frame_list").height('');
				$(this).height('');
				$(this).width('');
			}else{
				$("#frame_container").find('.my-container').css('height','');
				$("#frame_box").height(parseInt($("#frame_box").attr('value'))+parseInt(ui.size.height));
				$("#frame_list").width('');
				$("#frame_list").height(project.frames*60);
				$(this).height('');
				$(this).width('');
			}
			//$("#frame_list").height(120);
			//$("#frame_list").height(ui.size.height);
		}
	}).children().addClass('ui-icon ui-icon-triangle-2-e-w').css({
		'margin-right':'6px'
	});
	
	$( "#interval_menu" ).hide().menu({
		select: function(event, ui) {
			if(ui.item.text()=="0"){
				document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = 0;
				document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML = 0;
				$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
					send_frame_interval($(this).attr('value'),0);
				}).attr('data-interval',0).find('.frame_interval').html('0');
				send_frame_interval(document.getElementById("interval_menu").dataset.frame,0);
			}else if(ui.item.text()=="0.1"){
				document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = 100;
				document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML = 0.1;
				$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
					send_frame_interval($(this).attr('value'),100);
				}).attr('data-interval',100).find('.frame_interval').html('0.1');
				send_frame_interval(document.getElementById("interval_menu").dataset.frame,100);
			}else if(ui.item.text()=="0.2"){
				document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = 200;
				document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML = 0.2;
				$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
					send_frame_interval($(this).attr('value'),200);
				}).attr('data-interval',200).find('.frame_interval').html('0.2');
				send_frame_interval(document.getElementById("interval_menu").dataset.frame,200);
			}else if(ui.item.text()=="0.5"){
				document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = 500;
				document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML = 0.5;
				$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
					send_frame_interval($(this).attr('value'),500);
				}).attr('data-interval',500).find('.frame_interval').html('0.5');
				send_frame_interval(document.getElementById("interval_menu").dataset.frame,500);
			}else if(ui.item.text()=="1"){
				document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = 1000;
				document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML = 1;
				$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
					send_frame_interval($(this).attr('value'),1000);
				}).attr('data-interval',1000).find('.frame_interval').html('1');
				send_frame_interval(document.getElementById("interval_menu").dataset.frame,1000);
			}else if(ui.item.text()=="custom"){
				$("#popup_title").html('Custom Interval');
				$("#popup_content").html('<div id="interval_dialog">\
					Set time to delay current frame during animation.<br>\
					Delay:<input type="text" class="interval_spinner" id="interval_spinner" value="0.1" ><br>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					document.getElementById("frame_"+document.getElementById("interval_menu").dataset.frame ).dataset.interval = $("#interval_spinner").spinner("value") * 1000;
					document.getElementById("interval_"+document.getElementById("interval_menu").dataset.frame ).innerHTML =  $("#interval_spinner").spinner("value");
					$('#frame_list').children('.ui-selected, .ui-state-hover').each(function(){
						send_frame_interval($(this).attr('value'),$("#interval_spinner").spinner("value") * 1000);
					}).attr('data-interval',($("#interval_spinner").spinner("value") * 1000) ).find('.frame_interval').html( $("#interval_spinner").spinner("value") );
					send_frame_interval(document.getElementById("interval_menu").dataset.frame,$("#interval_spinner").spinner("value") * 1000);
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( ".interval_spinner" ).spinner({
					max: 101,	
					min: -1,
					step: 0.01,
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
					},
					change: function(){
						if(slider_or_spinner == false ){}
					}
				}).on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^[0-9]*\.?[0-9]*$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
				})
			}
		}
	});

	$("#frame_orientation_toggle").button({
		text: false,
		icons: {
		primary: "ui-icon-refresh"
		}
	}).click(function(){
		toggleFrameOrientation();
	}).css({
		'width':'14px',
		'padding':0,
		'margin':0
	}).hide().find('.ui-button-text').css('padding',0);
			
	$("#frame_showall").button({
		text: false,
		icons: {
		primary: "ui-icon-arrowthick-2-n-s"
		}
	}).prop('checked',true).button('refresh').click(function(){
		$( this ).button('refresh');
		if( $(this).next('label').attr('aria-pressed')=='true'){
			$( "#frame_showall" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-arrowthick-2-n-s" }
			}).next('label').attr('title','All Frames').css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
			project.showall = true;
		}else{
			$( "#frame_showall" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-arrowthickstop-1-w" }
			}).next('label').attr('title','Active Frame').css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
			project.showall = false;
		}
	}).next('label').addClass('ui-state-active').attr('aria-pressed',true).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
	
	$("#frame_play").button({
		text: false,
		icons: {
		primary: "ui-icon-play"
		}
	}).click(function(){
		if( $( "#frame_play span:first" ).hasClass('ui-icon-play') ){
			$( "#frame_play" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-stop" }
			}).find('.ui-button-text').css('padding',0);
			animation.start();
		}else{
			$( "#frame_play" ).button("option", {
				text: false,
				icons: { primary: "ui-icon-play" }
			}).find('.ui-button-text').css('padding',0);
			animation.stop();
		}
	}).css({
		'width':'14px',
		'padding':0,
		'margin':0
	}).find('.ui-button-text').css('padding',0);
	
	//$( "#window_slider" ).draggable({ handle: "div", containment: 'parent' });
	$( "#window_slider" ).resizable({ 
		containment: "parent",
		minWidth: 90,
		maxWidth: 90,
		alsoResizeReverse: "#window_slider2"
	}).droppable({
		drop: function( event, ui ) {
			dropInsideContainer($(event.target),$(ui.draggable));
			/*$(ui.draggable).detach().css({top: 0,left: 0}).appendTo(this);
			var resizer = $(event.target).find('.resizer');
			if(resizer.is('.ui-resizable'))resizer.hide();//resizable('destroy');
			$(ui.draggable).height('100%').width('100%').find('.my-container').height('calc(100% - 24px)').css({'border':'none'}).children('div[id="frame_box"],div[id="history_box"]').css({"width": "100%","height": "100%"}).children('ul[id="frame_list"],ul[id="history_list"]').css("height", "0px");
			*/
		}
	});
	$( "#window_slider2" ).resizable({ 
		containment: "parent",
		minWidth: 90,
		maxWidth: 90,
		start: function(event, ui) {
			
		},
		resize: function(event, ui) {
			var tempheight = $(this).outerHeight() + $( "#window_slider" ).outerHeight();
			if(tempheight > $(this).parent().parent().height() )$(this).outerHeight($(this).parent().parent().height() - $( "#window_slider" ).outerHeight());
		}
	}).droppable({
		drop: function( event, ui ) {
			dropInsideContainer($(event.target),$(ui.draggable));
			/*$(ui.draggable).detach().css({top: 0,left: 0}).appendTo(this);
			var resizer = $(event.target).find('.resizer');
			if(resizer.is('.ui-resizable'))resizer.hide();//resizable('destroy');
			$(ui.draggable).height('100%').width('100%').find('.my-container').height('calc(100% - 24px)').css({'border':'none'}).children('div[id="frame_box"],div[id="history_box"]').css({"width": "100%","height": "100%"}).children('ul[id="frame_list"],div[id="history_box"]').css("height", "0px");
			*/
		}
	});
	
	
	$( "#history_container span:last" ).resizable({
		minHeight:-1000,
		start: function(event, ui) {
			$("#history_box").attr('value',($("#history_box").height() - ui.size.height));
			
		},
		resize: function(event, ui) {
			$("#history_box").height(parseInt($("#history_box").attr('value'))+parseInt(ui.size.height));
			$(this).height('');
			$(this).width('');
		}
	});
	
	$( "#history_list" ).css({
		'list-style-type': 'none',
		'margin': 0,
		'padding': 0
	}).children().hover(
		function () {
			$(this).addClass('ui-state-hover');
		}, 
		function () {
			$(this).removeClass('ui-state-hover');
		}
	).click(
		function(){
			$(this).siblings().removeClass('ui-state-active');
			$(this).toggleClass('ui-state-active');
			myHistory[0].selected = $(this).attr('value');
			send_history_select(myHistory[0].selected);
			//prepare_history_canvas();
		}
	).css({
		'margin': '3px',
		'padding': '0.4em',
		'font-size': '14px'
	}).first().hide();
	
	$( "#historyresize_list" ).css({
		'list-style-type': 'none',
		'margin': 0,
		'padding': 0
	}).children().hover(
		function () {
			$(this).addClass('ui-state-hover');
		}, 
		function () {
			$(this).removeClass('ui-state-hover');
		}
	).click(
		function(){
			$(this).siblings().removeClass('ui-state-active');
			$(this).toggleClass('ui-state-active');
			//myHistory[0].selected = $(this).attr('value');
			//send_history_select(myHistory[0].selected);
			
			$("#popup_title").html('Undo Resize');
			$("#popup_content").html('<div id="undo_resize_dialog">\
					Are you sure you want to revert to the previous size?<br>\
					If you have made any new changes since resizing, those will be lost.\
				</div>');
			$("#popup_container").show();
			$("#popup_title").show();
			$("#popup_submit").unbind( "click" );
			$("#popup_submit").click(function(){
				revertResize();
				send_undo_resize();
				$("#popup_container").hide();	
				$("#popup_title").hide();				
			});
			$("#popup_cancel").unbind( "click" );
			$("#popup_cancel").click(function(){
				$("#popup_container").hide();	
				$("#popup_title").hide();				
			});
			
		}
	).css({
		'margin': '3px',
		'padding': '0.4em',
		'font-size': '14px'
	}).first().hide();
	
	$("#msgbox").bind("DOMSubtreeModified",function(){
		var div = document.getElementById("msgbox");
		if(project.console.scrolltop + $(this).height() == project.console.scrollheight || project.console.scrollheight==0){
			div.scrollTop = div.scrollHeight;
			project.console.scrolltop = div.scrollTop;
			project.console.scrollheight = div.scrollHeight;
		}
	});
	$("#msgbox").scroll( function() {
		var div = document.getElementById("msgbox");
		project.console.scrolltop = div.scrollTop;
		project.console.scrollheight = div.scrollHeight;
	});
	
	$( "#menu_file" ).parent().children()
	.button()
	.click(function() {
		var isopen = $( this ).parent().siblings('ul:eq('+$(this).index()+')').is(':visible');
		$( this ).parent().siblings('ul').hide();
		if(isopen==false){
			var menu = $( this ).parent().siblings('ul:eq('+$(this).index()+')').toggle().position({
				my: "left top",
				at: "left bottom",
				of: this
			});
			$( document ).one( "click", function() {
				menu.hide();
			});
			return false;
		}
	})
	.mouseover(function(){
		if($( this ).parent().siblings('ul').is(':visible')) {
			$( this ).parent().siblings('ul').hide();
			var menu = $( this ).parent().siblings('ul:eq('+$(this).index()+')').toggle().position({
				my: "left top",
				at: "left bottom",
				of: this
			});
			$( document ).one( "click", function() {
				menu.hide();
			});
			return false;
		}
	})
	.parent()
	.buttonset();
	$( "#menu_file_list, #menu_edit_list, #menu_select_list, #menu_window_list" )
	.hide()
	.menu({
		select: function(event, ui) {
			if(ui.item.text()=="New"){
				$("#popup_title").html('New');
				$("#popup_content").html('<div id="file_new_dialog">\
					Creating a new project will erase your current work.<br>\
					Width:<input type="text" class="file_new_dialog_spinner" id="file_new_dialog_width" value="'+(typeof(Storage) !== "undefined" && typeof(localStorage.new_dialog_width) !== "undefined" ? localStorage.new_dialog_width : 128 )+'" ><br>\
					Height:<input type="text" class="file_new_dialog_spinner" id="file_new_dialog_height" value="'+(typeof(Storage) !== "undefined" && typeof(localStorage.new_dialog_height) !== "undefined" ? localStorage.new_dialog_height : 128 )+'" ><br>\
					Frames:<input type="text" class="file_new_dialog_spinner" id="file_new_dialog_frames" value="'+(typeof(Storage) !== "undefined" && typeof(localStorage.new_dialog_frames) !== "undefined" ? localStorage.new_dialog_frames : 1 )+'" ><br>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					reset_project($("#file_new_dialog_frames").spinner("value"), $("#file_new_dialog_width").spinner("value"), $("#file_new_dialog_height").spinner("value"));
					$("#colorpicker_container").show();
					$("#playback_container").hide();
					$("#record_container").hide();
					$("#popup_container").hide();	
					$("#popup_title").hide();		
					if(typeof(Storage) !== "undefined") localStorage.new_dialog_width = JSON.stringify($("#file_new_dialog_width").spinner("value")) ; 
					if(typeof(Storage) !== "undefined") localStorage.new_dialog_height = JSON.stringify($("#file_new_dialog_height").spinner("value")) ; 					
					if(typeof(Storage) !== "undefined") localStorage.new_dialog_frames = JSON.stringify($("#file_new_dialog_frames").spinner("value")) ; 					
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( ".file_new_dialog_spinner" ).spinner({
					max: 2561,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
					},
					change: function(){
						if(slider_or_spinner == false ){}
					}
				}).each(function(){ $(this).spinner('option', 'max', ( $(this).attr("id")=="file_new_dialog_frames" ? 65 : 2561 ) ); })
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
				})
			}
			if(ui.item.text()=="Save"){
							saveFile( $("#filename").val() );
							//setTimeout(function(){ saveFile( $("#filename").val() ) }, 1000);
				/*var NewDialog = $('<div id="file_save_dialog">\
					<p>Specify the filename.</p>\
					Filename:<input type="text" id="file_save_dialog_name" ><br>\
					</div>');
				NewDialog.dialog({
					modal: true,
					title: "Save",
					show: 'clip',
					hide: 'clip',
					close: function(){ $(this).remove(); },
					buttons: [
						{text: "Save", click: function() {
							saveName = $('#file_save_dialog_name').val();
							setTimeout(function(){ saveFile( saveName ) }, 1000);
							//saveFile($('#file_save_dialog_name').val() );
							$(this).dialog("close");
						}},
						{text: "Cancel", click: function() {$(this).dialog("close")}}
					]
				});*/
				
			}
			if(ui.item.text()=="Png"){
				$("#popup_title").html('Png');
				$("#popup_content").html('<div id="file_export_dialog">\
					<select id="png_composition_select">\
					<option value="combine">Combined Frames</option>\
					<option value="separate">Separate Frames</option>\
					<option value="sheet">Sprite Sheet</option>\
					</select><br>\
					<div id="png_container"></div>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					//savePNG = {filename:$('#filename').val(), type:$('#png_composition_select').val(), startframe:$( "#png_range" ).slider( "values", 0 ), endframe:$( "#png_range" ).slider( "values", 1 ), columns:$('#png_columns').spinner( "value"), rows:$('#png_rows').spinner( "value"), direction:$('#png_direction').val()};
					//exportPng( savePNG );
					//setTimeout(function(){ exportPng( savePNG ) }, 1000);
					exportPng( {filename:$('#filename').val(), type:$('#png_composition_select').val(), startframe:$( "#png_range" ).slider( "values", 0 ), endframe:$( "#png_range" ).slider( "values", 1 ), columns:$('#png_columns').spinner( "value"), rows:$('#png_rows').spinner( "value"), direction:$('#png_direction').val() } );
					//exportPng( {filename:$('#file_export_dialog_name').val(), type:$('#png_composition_select').val(), startframe:$( "#png_range" ).slider( "values", 0 ), endframe:$( "#png_range" ).slider( "values", 1 ), columns:$('#png_columns').spinner( "value"), rows:$('#png_rows').spinner( "value"), direction:$('#png_direction').val() } );
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$('#file_export_dialog .file_export_input[type=text]').addClass("ui-corner-all").css({
					  'background' : '#444444',
					  'border-width' : '1px',
					  'padding' : '3px'
				});
				$('#png_composition_select').click(function(event,ui){
					if($(this).val()=='combine'){
						$("#png_container").empty();
					}else if($(this).val()=='separate'){
						$("#png_container").empty();
						$("#png_container").append('\
							<span></span>\
							<div id="png_range"></div>\
						');
						 $( "#png_range" ).slider({
							range: true,
							min: 0,
							max: project.frames-1,
							values: [ 0, project.frames-1 ],
							slide: function( event, ui ) {
								$( "#png_range" ).prev().text( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
							}
						});
						$( "#png_range" ).prev().text( $( "#png_range" ).slider( "values", 0 ) +
							" - " + $( "#png_range" ).slider( "values", 1 ) );
					}else if($(this).val()=='sheet'){
						$("#png_container").empty();
						$("#png_container").append('\
							Columns:<input type="text" class="png_sheet_spinner" id="png_columns" value="'+project.frames+'" ><br>\
							Rows:<input type="text" class="png_sheet_spinner" id="png_rows" value="1" ><br>\
							<span id="png_size"></span><br>\
							<select id="png_direction">\
								<option value="leftright">Left to Right</option>\
								<option value="topbottom">Top to Bottom</option>\
							</select><br>\
						');
						$( ".png_sheet_spinner" ).spinner({
							max: Math.floor(8192/project.width),	//canvas size limit is 8192 pixels I think, but we don't need all those..
							min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
							spin: function( event, ui ) {
								slider_or_spinner = false;
								max = $(this).spinner('option', 'max'),
								min = $(this).spinner('option', 'min');
								if ( ui.value > max-1 ) {
									$( this ).spinner( "value", min+1 );
									return false;
								} else if ( ui.value < min+1 ) {
									$( this ).spinner( "value", max-1 );
									return false;
								}
							},
							change: function(){
								if(slider_or_spinner == false ){}
							},
							stop: function(){
								$("#png_size").text( $( '#png_columns' ).spinner( "value")*project.width +"x"+ $( '#png_rows' ).spinner( "value")*project.height );
							}
						}).each(function(){ $(this).spinner('option', 'max', ( $(this).attr("id")=="png_columns" ? Math.floor(8192/project.width) : Math.floor(8192/project.height) ) ); })
						.on('input', function () {
							var val = this.value,
							$this = $(this),
							max = $this.spinner('option', 'max'),
							min = $this.spinner('option', 'min');
							if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
							this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
							slider_or_spinner = false;
						});
						$("#png_size").text( $( '#png_columns' ).spinner( "value")*project.width +"x"+ $( '#png_rows' ).spinner( "value")*project.height );
						$("#png_direction").css({
							'padding':'3px',
							'margin': 0,
							'font-size':'12px',
							'-webkit-border-radius':'4px',
							'-moz-border-radius':'4px',
							'border-radius':'4px',
							
							'background': '#333333',
							'color':'#888',
							'border':'none',
							'outline':'none',
							'display': 'inline-block',
							'cursor':'pointer'
						});
					}
				}).css({
					'padding':'3px',
					'margin': 0,
					'font-size':'12px',
					'-webkit-border-radius':'4px',
					'-moz-border-radius':'4px',
					'border-radius':'4px',
					
					'background': '#333333',
					'color':'#888',
					'border':'none',
					'outline':'none',
					'display': 'inline-block',
					'cursor':'pointer'
				});
			}
			if(ui.item.text()=="Gif"){
				$("#popup_title").html('Gif');
				$("#popup_content").html('<div id="file_export_dialog">\
					Transparent color:<input id="gifcolorpicker" type="color" value="#ff00ff">\
					<p style="font-size:9px;">If this color is in your image, it will become transparent in the gif.</p>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					exportGif($('#filename').val()+'.gif', $('#gifcolorpicker').val()  );
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				
			}
			if(ui.item.text()=="Undo"){
				if(myHistory[0].selected>0){
					var h = $('#history_list li[class*="ui-state-active"]');
					h.siblings().removeClass('ui-state-active');
					h.toggleClass('ui-state-active');
					h.prev().toggleClass('ui-state-active');
					myHistory[0].selected = h.prev().attr('value');
					send_history_select(myHistory[0].selected);
				}
			}
			if(ui.item.text()=="Redo"){
				if(myHistory[0].selected<myHistory[0].layers.length-1){
					var h = $('#history_list li[class*="ui-state-active"]');
					h.siblings().removeClass('ui-state-active');
					h.toggleClass('ui-state-active');
					h.next().toggleClass('ui-state-active');
					myHistory[0].selected = h.next().attr('value');
					send_history_select(myHistory[0].selected);
				}
			}
			if(ui.item.text()=="Remove Frame"){
				send_remove_frame();
				removeFrame(project.currentframe);
			}
			if(ui.item.text()=="Add Frame"){
				send_add_frame();
				addFrame(project.currentframe);
			}
			if(ui.item.text()=="Spritesheet"){
				$("#popup_title").html('Spritesheet');
				$("#popup_content").html('<div id="file_spritesheet_dialog">\
						This action will cut up your image based upon your specifications below and create frames out of the cells. The interval value will be set for each frame.<br><hr>\
						Columns:<input type="text" class="png_sheet_spinner" id="png_columns" value="'+project.frames+'" ><br>\
						Rows:<input type="text" class="png_sheet_spinner" id="png_rows" value="1" ><br>\
						<span id="png_size"></span><br>\
						<select id="png_direction">\
							<option value="leftright">Left to Right</option>\
							<option value="topbottom">Top to Bottom</option>\
						</select><br>\
						Frame Interval(millisecs):<input type="text" class="png_sheet_spinner" id="spritesheet_interval" value="1" ><br><hr>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					convertSpritesheet( {columns:$('#png_columns').spinner( "value"), rows:$('#png_rows').spinner( "value"), direction:$('#png_direction').val(), interval:$('#spritesheet_interval').val() } );
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( ".png_sheet_spinner" ).spinner({
					max: 1023,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
					},
					change: function(){
						if(slider_or_spinner == false ){}
					},
					stop: function(){
						$("#png_size").text( Math.floor(project.width/$( '#png_columns' ).spinner( "value")) +"x"+ Math.floor(project.height/$( '#png_rows' ).spinner( "value")) );
					}
				})
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
				}).width(40);
				$("#png_size").text( Math.floor(project.width/$( '#png_columns' ).spinner( "value")) +"x"+ Math.floor(project.height/$( '#png_rows' ).spinner( "value")) );
				$("#png_direction").css({
					'padding':'3px',
					'margin': 0,
					'font-size':'12px',
					'-webkit-border-radius':'4px',
					'-moz-border-radius':'4px',
					'border-radius':'4px',
					
					'background': '#333333',
					'color':'#888',
					'border':'none',
					'outline':'none',
					'display': 'inline-block',
					'cursor':'pointer'
				});
			}
			if(ui.item.text()=="Map Size"){
				$("#popup_title").html('Resize Map');
				$("#popup_content").html('<div id="map_size_dialog" data-direction="0">\
					Map will be extended based upon following specifications.<br><hr>\
					<div style="text-align:center;">\
					<button id="map_size_topleft" class="map_size_side "></button>\
					<button id="map_size_top" class="map_size_side "></button>\
					<button id="map_size_topright" class="map_size_side "></button>\
					</div>\
					<div style="text-align:center;">\
					<button id="map_size_left" class="map_size_side "></button>\
					<button id="map_size_middle" class="map_size_side "></button>\
					<button id="map_size_right" class="map_size_side "></button>\
					</div>\
					<div style="text-align:center;">\
					<button id="map_size_bottomleft" class="map_size_side "></button>\
					<button id="map_size_bottom" class="map_size_side "></button>\
					<button id="map_size_bottomright" class="map_size_side "></button>\
					</div>\
					<table width="100%" padding="2"><tr><td valign="top" rowspan="2">\
					Scale type:<button id="imagesize_unit" value="tiles">Tiles</button><br>\
					<input type="checkbox" id="imagesize_proportionate"><label for="imagesize_proportionate">Proportionate</label>\
					</td><td>\
					Width:</td><td><input type="text" class="map_size_dialog_spinner" id="map_size_dialog_width" value="'+tile.dim.w+'" ><span class="imagesize_unit_text">tile</span>\
					</td></tr><tr><td>\
					Height:</td><td><input type="text" class="map_size_dialog_spinner" id="map_size_dialog_height" value="'+tile.dim.h+'" ><span class="imagesize_unit_text">tile</span>\
					</td></tr></table>\
					<hr>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					var w=$('#map_size_dialog_width').val(), h=$('#map_size_dialog_height').val();
					if($('#imagesize_unit').text()=='Percent'){
						w = Math.max(1,Math.floor(tile.dim.w*(w*0.01)));
						h = Math.max(1,Math.floor(tile.dim.h*(h*0.01)));
					}
					resizeMap(w,h,$( "#map_size_dialog" ).data('direction') );
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( "#imagesize_unit" ).button().click(function(){
					if($(this).text()=='Tiles'){
						$(this).text('Percent');
						$( "span.imagesize_unit_text" ).text('%');
					}else{
						$(this).text('Tiles');
						$( "span.imagesize_unit_text" ).text('tiles');
					}
				}).find('.ui-button-text').css({'padding':'0px 4px 0px 4px','font-size' : '12px'});
				
				$( "#imagesize_proportionate" ).button().prop('checked',false).click(function(){
					if( $(this).next('label').attr('aria-pressed')=='true'){
						//$(this).attr('checked', false);
					}
				}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
					'font-size' : '12px'});

					
				$( "#map_size_dialog" ).data('direction',{x:0,y:0} );
				$( ".map_size_dialog_spinner" ).spinner({
					max: 2561,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
						
						if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
							if($('#imagesize_unit').text()=='Tiles'){
								if($(this).attr('id')=='map_size_dialog_width'){
									var ratio = ui.value/tile.dim.w;
									$('#map_size_dialog_height').spinner('value',tile.dim.h*ratio);
								}else if($(this).attr('id')=='map_size_dialog_height'){
									var ratio = ui.value/tile.dim.h;
									$('#map_size_dialog_width').spinner('value',tile.dim.w*ratio);
								}
							}else{
								if($(this).attr('id')=='map_size_dialog_width'){
									$('#map_size_dialog_height').spinner('value',ui.value);
								}else if($(this).attr('id')=='map_size_dialog_height'){
									$('#map_size_dialog_width').spinner('value',ui.value);
								}
							}
						}
					},
					change: function(){
						if(slider_or_spinner == false ){}
					}
				}).width(40).each(function(){ $(this).spinner('option', 'max', 2561  ); })
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
					
					if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
						if($('#imagesize_unit').text()=='Tiles'){
							if($(this).attr('id')=='map_size_dialog_width'){
								var ratio = val/tile.dim.w;
								$('#map_size_dialog_height').spinner('value',tile.dim.h*ratio);
							}else if($(this).attr('id')=='map_size_dialog_height'){
								var ratio = val/tile.dim.h;
								$('#map_size_dialog_width').spinner('value',tile.dim.w*ratio);
							}
						}else{
							if($(this).attr('id')=='map_size_dialog_width'){
								$('#map_size_dialog_height').spinner('value',val);
							}else if($(this).attr('id')=='map_size_dialog_height'){
								$('#map_size_dialog_width').spinner('value',val);
							}
						}
					}
				})
				$(".map_size_side").each(function(i){
					var idname;
					switch (i)
					{
					   case 0:
						   idname = 'ui-icon-arrowthick-1-nw';
						   break;
					   case 1:
						   idname = 'ui-icon-arrowthick-1-n';
						   break;
					   case 2: 
						   idname = 'ui-icon-arrowthick-1-ne';
						   break;
					   case 3: 
						   idname = 'ui-icon-arrowthick-1-w';
						   break;
					   case 4: 
						   idname = '';
						   break;
					   case 5: 
						   idname = 'ui-icon-arrowthick-1-e';
						   break;
					   case 6: 
						   idname = 'ui-icon-arrowthick-1-sw';
						   break;
					   case 7: 
						   idname = 'ui-icon-arrowthick-1-s';
						   break;
					   case 8: 
						   idname = 'ui-icon-arrowthick-1-se';
						   break;

					   default: 
						   idname = '';
						   break;
					}
					$(this).button({
						text:false,
						icons: {
						primary: idname
						}
					});
				});
				$(".map_size_side").click(function(event){
					$(".map_size_side").button({ icons: { primary: '' } });
					var idname;
					switch ($(".map_size_side").index(this))
					{
						case 0:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#map_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#map_size_dialog" ).data('direction',{x:1,y:1} );
							break;
						case 1:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#map_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#map_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#map_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#map_size_dialog" ).data('direction',{x:0,y:1} );
							break;
						case 2:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#map_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$( "#map_size_dialog" ).data('direction',{x:-1,y:1} );
							break;
						case 3:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#map_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#map_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#map_size_dialog" ).data('direction',{x:1,y:0} );
							break;
						case 4:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#map_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#map_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#map_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#map_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#map_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#map_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#map_size_dialog" ).data('direction',{x:0,y:0} );
							break;
						case 5:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#map_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#map_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#map_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$( "#map_size_dialog" ).data('direction',{x:-1,y:0} );
							break;
						case 6:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#map_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$( "#map_size_dialog" ).data('direction',{x:1,y:-1} );
							break;
						case 7:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#map_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#map_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$( "#map_size_dialog" ).data('direction',{x:0,y:-1} );
							break;
						case 8:
							$(this).button({ icons: { primary: '' } });
							$('#map_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#map_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#map_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$( "#map_size_dialog" ).data('direction',{x:-1,y:-1} );
							break;

					   default: 
						   idname = '';
						   break;
					}
				});
			}
			if(ui.item.text()=="Image Size"){
				$("#popup_title").html('Resize Image');
				$("#popup_content").html('<div id="image_size_dialog">\
					Image will be stretched to fit new dimensions.<br>\
					<strong>*History data will be cleared.</strong><br><hr>\
					<table width="100%" padding="2"><tr><td valign="top" rowspan="2">\
					Scale type:<button id="imagesize_unit" value="pixel">Pixel</button><br>\
					<input type="checkbox" id="imagesize_proportionate"><label for="imagesize_proportionate">Proportionate</label>\
					</td><td>\
					Width:</td><td><input type="text" class="image_size_dialog_spinner" id="image_size_dialog_width" value="'+project.width+'" ><span class="imagesize_unit_text">px</span>\
					</td></tr><tr><td>\
					Height:</td><td><input type="text" class="image_size_dialog_spinner" id="image_size_dialog_height" value="'+project.height+'" ><span class="imagesize_unit_text">px</span>\
					</td></tr></table><hr>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
				
					resizeLayers = new resizeLayersData();
					resizeLayers.getOrder();
					project.canvaslayer.forEach(function(entry){
						resizeLayers.layer.push(entry.toDataURL() );
					});
					send_save_resize();
							
					var w=$('#image_size_dialog_width').val(), h=$('#image_size_dialog_height').val();
					if($('#imagesize_unit').text()=='Percent'){
						w = Math.max(1,Math.floor(project.width*(w*0.01)));
						h = Math.max(1,Math.floor(project.height*(h*0.01)));
					}
					send_history_select(myHistory[0].selected);
					send_resize_image(w,h );
					resizeImage(w,h );
					
					addResizeUndo();
					send_add_resize_undo();
					
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( "#imagesize_unit" ).button().click(function(){
					if($(this).text()=='Pixel'){
						$(this).text('Percent');
						$( "span.imagesize_unit_text" ).text('%');
					}else{
						$(this).text('Pixel');
						$( "span.imagesize_unit_text" ).text('px');
					}
				}).find('.ui-button-text').css({'padding':'0px 4px 0px 4px','font-size' : '12px'});
				
				$( "#imagesize_proportionate" ).button().prop('checked',false).click(function(){
					if( $(this).next('label').attr('aria-pressed')=='true'){
						//$(this).attr('checked', false);
					}
				}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
					'font-size' : '12px'});

		
				$( ".image_size_dialog_spinner" ).spinner({
					max: 2561,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
						
						if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
							if($('#imagesize_unit').text()=='Pixel'){
								if($(this).attr('id')=='image_size_dialog_width'){
									var ratio = ui.value/project.width;
									$('#image_size_dialog_height').spinner('value',project.height*ratio);
								}else if($(this).attr('id')=='image_size_dialog_height'){
									var ratio = ui.value/project.height;
									$('#image_size_dialog_width').spinner('value',project.width*ratio);
								}
							}else{
								if($(this).attr('id')=='image_size_dialog_width'){
									$('#image_size_dialog_height').spinner('value',ui.value);
								}else if($(this).attr('id')=='image_size_dialog_height'){
									$('#image_size_dialog_width').spinner('value',ui.value);
								}
							}
						}
					},
					change: function(event,ui){
					}
				}).width(40).each(function(){ $(this).spinner('option', 'max', 2561  ); })
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
					
					if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
						if($('#imagesize_unit').text()=='Pixel'){
							if($(this).attr('id')=='image_size_dialog_width'){
								var ratio = val/project.width;
								$('#image_size_dialog_height').spinner('value',project.height*ratio);
							}else if($(this).attr('id')=='image_size_dialog_height'){
								var ratio = val/project.height;
								$('#image_size_dialog_width').spinner('value',project.width*ratio);
							}
						}else{
							if($(this).attr('id')=='image_size_dialog_width'){
								$('#image_size_dialog_height').spinner('value',val);
							}else if($(this).attr('id')=='image_size_dialog_height'){
								$('#image_size_dialog_width').spinner('value',val);
							}
						}
					}
				});
			}
			if(ui.item.text()=="Canvas Size"){
				$("#popup_title").html('Resize Canvas');
				$("#popup_content").html('<div id="canvas_size_dialog" data-direction="0">\
					Canvas will be extended based upon following specifications.<br>\
					<strong>*History data will be cleared.</strong><br><hr>\
					<div style="text-align:center;">\
					<button id="canvas_size_topleft" class="canvas_size_side "></button>\
					<button id="canvas_size_top" class="canvas_size_side "></button>\
					<button id="canvas_size_topright" class="canvas_size_side "></button>\
					</div>\
					<div style="text-align:center;">\
					<button id="canvas_size_left" class="canvas_size_side "></button>\
					<button id="canvas_size_middle" class="canvas_size_side "></button>\
					<button id="canvas_size_right" class="canvas_size_side "></button>\
					</div>\
					<div style="text-align:center;">\
					<button id="canvas_size_bottomleft" class="canvas_size_side "></button>\
					<button id="canvas_size_bottom" class="canvas_size_side "></button>\
					<button id="canvas_size_bottomright" class="canvas_size_side "></button>\
					</div>\
					<table width="100%" padding="2"><tr><td valign="top" rowspan="2">\
					Scale type:<button id="imagesize_unit" value="pixel">Pixel</button><br>\
					<input type="checkbox" id="imagesize_proportionate"><label for="imagesize_proportionate">Proportionate</label>\
					</td><td>\
					Width:</td><td><input type="text" class="canvas_size_dialog_spinner" id="canvas_size_dialog_width" value="'+project.width+'" ><span class="imagesize_unit_text">px</span>\
					</td></tr><tr><td>\
					Height:</td><td><input type="text" class="canvas_size_dialog_spinner" id="canvas_size_dialog_height" value="'+project.height+'" ><span class="imagesize_unit_text">px</span>\
					</td></tr></table>\
					<hr>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
				
					resizeLayers = new resizeLayersData();
					resizeLayers.getOrder();
					project.canvaslayer.forEach(function(entry){
						resizeLayers.layer.push(entry.toDataURL() );
					});
					send_save_resize();
							
					var w=$('#canvas_size_dialog_width').val(), h=$('#canvas_size_dialog_height').val();
					if($('#imagesize_unit').text()=='Percent'){
						w = Math.max(1,Math.floor(project.width*(w*0.01)));
						h = Math.max(1,Math.floor(project.height*(h*0.01)));
					}
					send_history_select(myHistory[0].selected);
					send_resize_canvas(w,h,$( "#canvas_size_dialog" ).data('direction') );
					resizeCanvas(w,h,$( "#canvas_size_dialog" ).data('direction') );
					
					addResizeUndo();
					send_add_resize_undo();
					
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( "#imagesize_unit" ).button().click(function(){
					if($(this).text()=='Pixel'){
						$(this).text('Percent');
						$( "span.imagesize_unit_text" ).text('%');
					}else{
						$(this).text('Pixel');
						$( "span.imagesize_unit_text" ).text('px');
					}
				}).find('.ui-button-text').css({'padding':'0px 4px 0px 4px','font-size' : '12px'});
				
				$( "#imagesize_proportionate" ).button().prop('checked',false).click(function(){
					if( $(this).next('label').attr('aria-pressed')=='true'){
						//$(this).attr('checked', false);
					}
				}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
					'font-size' : '12px'});

					
				$( "#canvas_size_dialog" ).data('direction',{x:0,y:0} );
				$( ".canvas_size_dialog_spinner" ).spinner({
					max: 2561,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
						
						if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
							if($('#imagesize_unit').text()=='Pixel'){
								if($(this).attr('id')=='canvas_size_dialog_width'){
									var ratio = ui.value/project.width;
									$('#canvas_size_dialog_height').spinner('value',project.height*ratio);
								}else if($(this).attr('id')=='canvas_size_dialog_height'){
									var ratio = ui.value/project.height;
									$('#canvas_size_dialog_width').spinner('value',project.width*ratio);
								}
							}else{
								if($(this).attr('id')=='canvas_size_dialog_width'){
									$('#canvas_size_dialog_height').spinner('value',ui.value);
								}else if($(this).attr('id')=='canvas_size_dialog_height'){
									$('#canvas_size_dialog_width').spinner('value',ui.value);
								}
							}
						}
					},
					change: function(){
						if(slider_or_spinner == false ){}
					}
				}).width(40).each(function(){ $(this).spinner('option', 'max', 2561  ); })
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
					
					if($(this).is(':focus') && $("#imagesize_proportionate").next('label').attr('aria-pressed')=='true' ){
						if($('#imagesize_unit').text()=='Pixel'){
							if($(this).attr('id')=='canvas_size_dialog_width'){
								var ratio = val/project.width;
								$('#canvas_size_dialog_height').spinner('value',project.height*ratio);
							}else if($(this).attr('id')=='canvas_size_dialog_height'){
								var ratio = val/project.height;
								$('#canvas_size_dialog_width').spinner('value',project.width*ratio);
							}
						}else{
							if($(this).attr('id')=='canvas_size_dialog_width'){
								$('#canvas_size_dialog_height').spinner('value',val);
							}else if($(this).attr('id')=='canvas_size_dialog_height'){
								$('#canvas_size_dialog_width').spinner('value',val);
							}
						}
					}
				})
				$(".canvas_size_side").each(function(i){
					var idname;
					switch (i)
					{
					   case 0:
						   idname = 'ui-icon-arrowthick-1-nw';
						   break;
					   case 1:
						   idname = 'ui-icon-arrowthick-1-n';
						   break;
					   case 2: 
						   idname = 'ui-icon-arrowthick-1-ne';
						   break;
					   case 3: 
						   idname = 'ui-icon-arrowthick-1-w';
						   break;
					   case 4: 
						   idname = '';
						   break;
					   case 5: 
						   idname = 'ui-icon-arrowthick-1-e';
						   break;
					   case 6: 
						   idname = 'ui-icon-arrowthick-1-sw';
						   break;
					   case 7: 
						   idname = 'ui-icon-arrowthick-1-s';
						   break;
					   case 8: 
						   idname = 'ui-icon-arrowthick-1-se';
						   break;

					   default: 
						   idname = '';
						   break;
					}
					$(this).button({
						text:false,
						icons: {
						primary: idname
						}
					});
				});
				$(".canvas_size_side").click(function(event){
					$(".canvas_size_side").button({ icons: { primary: '' } });
					var idname;
					switch ($(".canvas_size_side").index(this))
					{
						case 0:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#canvas_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#canvas_size_dialog" ).data('direction',{x:1,y:1} );
							break;
						case 1:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#canvas_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#canvas_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#canvas_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#canvas_size_dialog" ).data('direction',{x:0,y:1} );
							break;
						case 2:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#canvas_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$( "#canvas_size_dialog" ).data('direction',{x:-1,y:1} );
							break;
						case 3:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#canvas_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#canvas_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#canvas_size_dialog" ).data('direction',{x:1,y:0} );
							break;
						case 4:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_topleft').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#canvas_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#canvas_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#canvas_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$('#canvas_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#canvas_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$('#canvas_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-se' } });
							$( "#canvas_size_dialog" ).data('direction',{x:0,y:0} );
							break;
						case 5:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_top').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#canvas_size_topright').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#canvas_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-sw' } });
							$('#canvas_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-s' } });
							$( "#canvas_size_dialog" ).data('direction',{x:-1,y:0} );
							break;
						case 6:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#canvas_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$( "#canvas_size_dialog" ).data('direction',{x:1,y:-1} );
							break;
						case 7:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_left').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-ne' } });
							$('#canvas_size_bottomleft').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$('#canvas_size_bottomright').button({ icons: { primary: 'ui-icon-arrowthick-1-e' } });
							$( "#canvas_size_dialog" ).data('direction',{x:0,y:-1} );
							break;
						case 8:
							$(this).button({ icons: { primary: '' } });
							$('#canvas_size_middle').button({ icons: { primary: 'ui-icon-arrowthick-1-nw' } });
							$('#canvas_size_right').button({ icons: { primary: 'ui-icon-arrowthick-1-n' } });
							$('#canvas_size_bottom').button({ icons: { primary: 'ui-icon-arrowthick-1-w' } });
							$( "#canvas_size_dialog" ).data('direction',{x:-1,y:-1} );
							break;

					   default: 
						   idname = '';
						   break;
					}
				});
			}
			if(ui.item.text()=="Remove Records" && peerlist.length==0){
				$("#popup_title").html('Remove Records');
				$("#popup_content").html('<div id="file_spritesheet_dialog">\
						When you create an image, each step is recorded and this gets stored when you save your work as a pxl file.<br>\
						This action will remove all of those previous records so that when you save a new pxl file it won\'t include them.<br>\
						The purpose of this action is to allow users to keep their filesize low as storing their process increases filesize.<br>\
						Are you sure you want to remove the records?\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					removeRecords();
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
			}else if(ui.item.text()=="Remove Records") openDisabled('Remove Records');
			if(ui.item.text()=="Settings"){
				$("#popup_title").html('Settings');
				$("#popup_content").html('<div id="settings_dialog">\
					Grid Width:<input type="text" class="settings_spinner" id="grid_width" value="'+project.grid.x+'" ><br>\
					Grid Height:<input type="text" class="settings_spinner" id="grid_height" value="'+project.grid.y+'" ><br>\
					Background Color:<input type="color" id="bg_color" value="'+tool.bg+'" ><br>\
					<input type="checkbox" id="invert_mouse_wheel_radio"><label for="invert_mouse_wheel_radio">Invert Mouse Wheel</label><br>\
					</div>');
				$("#popup_container").show();
				$("#popup_title").show();
				$("#popup_submit").unbind( "click" );
				$("#popup_submit").click(function(){
					if(typeof(Storage) !== "undefined") localStorage.grid = JSON.stringify(project.grid) ; 
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				$("#popup_cancel").unbind( "click" );
				$("#popup_cancel").click(function(){
					$("#popup_container").hide();	
					$("#popup_title").hide();				
				});
				
				$( "#invert_mouse_wheel_radio" ).button().prop('checked',false).click(function(){
					if(typeof(Storage) !== "undefined") localStorage.invertmousewheel = ($(this).next('label').attr('aria-pressed')=='true'?'false':'true');
					if( $(this).next('label').attr('aria-pressed')=='true'){
						mouse.invert = false;
					}else mouse.invert = true;
				}).next().find('.ui-button-text').click(function(){$(this).parent().click();}).css({'user-select':'none','padding':'0px 4px 0px 4px',
					'font-size' : '12px'});
				if(typeof(Storage) !== "undefined" && localStorage.invertmousewheel=='true')$( "#invert_mouse_wheel_radio" ).prop('checked',false).click();
				
				$('#bg_color').change(function(){
					$("#canvas_bg_color").css( "background", $(this).val() );
					$("#minicanvas_bg_color").css( "background", $(this).val() );
					tool.bg = $(this).val();
					if(typeof(Storage) !== "undefined")localStorage.bg = $(this).val();
				});
				$( ".settings_spinner" ).spinner({
					max: 128,	//canvas size limit is 8192 pixels I think, but we don't need all those..
					min: 0,		//canvas must be greater than 0, so we set this to 0 since we'll be adding one to it
					spin: function( event, ui ) {
						slider_or_spinner = false;
						max = $(this).spinner('option', 'max'),
						min = $(this).spinner('option', 'min');
						if ( ui.value > max-1 ) {
							$( this ).spinner( "value", min+1 );
							return false;
						} else if ( ui.value < min+1 ) {
							$( this ).spinner( "value", max-1 );
							return false;
						}
					},
					stop: function(){
						project.grid.x = $( "#grid_width" ).spinner( "value" );
						project.grid.y = $( "#grid_height" ).spinner( "value" );
					}
				})
				.on('input', function () {
					var val = this.value,
					$this = $(this),
					max = $this.spinner('option', 'max'),
					min = $this.spinner('option', 'min');
					if (!val.match(/^\d+$/)) val = min+1; //we want only number, no alpha
					this.value = val > max-1 ? max-1 : val < min+1 ? min+1 : val;
					slider_or_spinner = false;
				})
			}
			if(ui.item.text()=="Frames"){
				$("#frame_container").toggle();
			}
			if(ui.item.text()=="History"){
				$("#history_container").toggle();
			}
			if(ui.item.text()=="Color/Tool"){
				$("#colorpicker_container").toggle();
			}
			if(ui.item.text()=="Secondary View"){
				$('#mini_container').toggle();
				if(typeof(Storage) !== 'undefined')localStorage.mini_container = $('#mini_container').css('display') ;
			}
			if(approveContinue() && myHistory[0].rotation.degree==0){
				if(ui.item.text()=="Flip Horizontally"){
					flipSelection(myHistory[0].id,{x:1,y:0} );
					send_select_flip({x:1,y:0});
				}
				if(ui.item.text()=="Flip Vertically"){
					flipSelection(myHistory[0].id,{x:0,y:1} );
					send_select_flip({x:0,y:1});
				}
				if(ui.item.text()=="Rotate Clockwise"){
					rotateSelection(myHistory[0].id,true );
					send_select_rotate(true);
				}
				if(ui.item.text()=="Rotate Counter-Clockwise"){
					rotateSelection(myHistory[0].id,false );
					send_select_rotate(false);
				}
				if(ui.item.text()=="Crop"){
					if(myHistory[0].trace.length>0){
						$("#popup_title").html('Crop');
						$("#popup_content").html('<div id="crop_dialog">\
							*History data will be cleared.<br>\
							</div>');
						$("#popup_container").show();
						$("#popup_title").show();
						$("#popup_submit").unbind( "click" );
						$("#popup_submit").click(function(){
							
							resizeLayers = new resizeLayersData();
							resizeLayers.getOrder();
							project.canvaslayer.forEach(function(entry){
								resizeLayers.layer.push(entry.toDataURL() );
							});
							send_save_resize();
	
							var tempclip = myHistory[0].selectionclip;
							send_history_select(myHistory[0].selected);
							send_resize_canvas(myHistory[0].selectionclip.x2, myHistory[0].selectionclip.y2, {x:1,y:1} );
							resizeCanvas(myHistory[0].selectionclip.x2, myHistory[0].selectionclip.y2, {x:1,y:1} );
							send_resize_canvas(tempclip.x2-tempclip.x, tempclip.y2-tempclip.y, {x:-1,y:-1} );
							resizeCanvas(tempclip.x2-tempclip.x, tempclip.y2-tempclip.y, {x:-1,y:-1} );
							
							addResizeUndo();
							send_add_resize_undo();
							
							$("#popup_container").hide();	
							$("#popup_title").hide();				
						});
						$("#popup_cancel").unbind( "click" );
						$("#popup_cancel").click(function(){
							$("#popup_container").hide();	
							$("#popup_title").hide();				
						});
					}			
				}
				if(ui.item.text()=="Cut"){
					copySelection(myHistory[0].id);
					send_copy_selection();
					if(approveContinue()){
						if(myHistory[0].selectionclipped == false){
						
							commitHistory(myHistory[0].id);
							//if clearing section, keep backup of what was there so we can pass to historylist(so we can restore it).
							var backupcanvas = document.createElement("canvas");
							backupcanvas.width = project.width;
							backupcanvas.height = project.height;
							var backupcontext = backupcanvas.getContext("2d");
							backupcontext.drawImage(project.canvaslayer[project.currentframe],0,0);
						
							myHistory[0].selectionsetclip = true;
							selectClip(myHistory[0].id);
							var type = "cut";
							
							myHistory[0].context.drawImage(myHistory[0].selectionclipcanvas,myHistory[0].selectionoffset.x,myHistory[0].selectionoffset.y);
							
							claimHistory(myHistory[0].id,myHistory[0].canvas);
							myHistory[0].layers.push(new historylayerdata("Delete",myHistory[0].canvas,myHistory[0],true,backupcanvas) );
							project.contextlayer[project.currentframe].globalCompositeOperation = 'destination-out';
							project.contextlayer[project.currentframe].drawImage(myHistory[0].canvas,0,0);
							project.contextlayer[project.currentframe].globalCompositeOperation = 'source-over';
						
							myHistory[0].context.clearRect(0, 0, myHistory[0].canvas.width, myHistory[0].canvas.height);
							send_select_clip(type);
							
							selectClearClip(myHistory[0].id);
							send_select_clear();
							//make sure selection is not selecting anything
							myHistory[0].selectionsetclip = false;
							myHistory[0].selectionpoints.push( {x:0,y:0} );
							//myHistory[0].selectionclip.x = 0, myHistory[0].selectionclip.y = 0;
							myHistory[0].selectionclip.x2 = myHistory[0].selectionclip.x, myHistory[0].selectionclip.y2 = myHistory[0].selectionclip.y;
						}else{
							myHistory[0].selectionclipcontext.clearRect(0, 0, myHistory[0].selectionclipcanvas.width, myHistory[0].selectionclipcanvas.height);
							myHistory[0].selectionclipped = false;
							send_clip_clear();
						}
					}
				}
				if(ui.item.text()=="Copy"){
					copySelection(myHistory[0].id);
					send_copy_selection();
				}
				if(ui.item.text()=="Paste"){
					pasteSelection(myHistory[0].id);
					send_paste_selection();
				}
				if(ui.item.text()=="Clear"){
					if(approveContinue()){
						if(myHistory[0].selectionclipped == false){
						
							commitHistory(myHistory[0].id);
							//if clearing section, keep backup of what was there so we can pass to historylist(so we can restore it).
							var backupcanvas = document.createElement("canvas");
							backupcanvas.width = project.width;
							backupcanvas.height = project.height;
							var backupcontext = backupcanvas.getContext("2d");
							backupcontext.drawImage(project.canvaslayer[project.currentframe],0,0);
						
							myHistory[0].selectionsetclip = true;
							selectClip(myHistory[0].id);
							var type = "cut";
							
							myHistory[0].context.drawImage(myHistory[0].selectionclipcanvas,myHistory[0].selectionoffset.x,myHistory[0].selectionoffset.y);
							
							claimHistory(myHistory[0].id,myHistory[0].canvas);
							myHistory[0].layers.push(new historylayerdata("Delete",myHistory[0].canvas,myHistory[0],true,backupcanvas) );
							project.contextlayer[project.currentframe].globalCompositeOperation = 'destination-out';
							project.contextlayer[project.currentframe].drawImage(myHistory[0].canvas,0,0);
							project.contextlayer[project.currentframe].globalCompositeOperation = 'source-over';
						
							myHistory[0].context.clearRect(0, 0, myHistory[0].canvas.width, myHistory[0].canvas.height);
							send_select_clip(type);
							
							selectClearClip(myHistory[0].id);
							send_select_clear();
							//make sure selection is not selecting anything
							myHistory[0].selectionsetclip = false;
							myHistory[0].selectionpoints.push( {x:0,y:0} );
							myHistory[0].selectionclip.x = 0, myHistory[0].selectionclip.y = 0;
							myHistory[0].selectionclip.x2 = 0, myHistory[0].selectionclip.y2 = 0;
						}else{
							myHistory[0].selectionclipcontext.clearRect(0, 0, myHistory[0].selectionclipcanvas.width, myHistory[0].selectionclipcanvas.height);
							myHistory[0].selectionclipped = false;
							send_clip_clear();
						}
					}
				}
			}
			
		}
	})
	.css({
		'z-index':'100',
		'position': 'absolute'
	});
	
	$( "#zoom_text" ).button().click(function() {
		//$( this ).next().toggle();
		var menu = $( "#zoom_list").toggle().position({
			my: "left top",
			at: "left bottom",
			of: this
		});
		$( document ).one( "click", function() {
			menu.hide();
		});
		return false;
	}).css({
		'font-size':'10px',
		'padding':'4px'
	});
	$( "#zoom_list" )
	.hide()
	.menu({
		select: function(event, ui) {
				zoomSet(ui.item.text().substr(0,1));
		}
	});
	
	$( "#secondary_zoom_text" ).button().click(function() {
		//$( this ).next().toggle();
		var menu = $( "#secondary_zoom_list").toggle().position({
			my: "left top",
			at: "left bottom",
			of: this
		});
		$( document ).one( "click", function() {
			menu.hide();
		});
		return false;
	}).css({
		'font-size':'10px',
		'padding':'4px'
	});
	$( "#secondary_zoom_list" )
	.hide()
	.menu({
		select: function(event, ui) {
				zoomSetSecondary(ui.item.text().substr(0,1));
		}
	});
	
	
	$( "#save_map_image" ).button({
		text: false,
		icons: {
		primary: "ui-icon-image"
		}
	}).click(function(){
		saveMapImage($("#filename").val() );
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#load_map" ).button({
		text: false,
		icons: {
		primary: "ui-icon-folder-open"
		}
	}).click(function(){
		$('#file_load_map').click();
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#load_map_tmx" ).button({
		text: false,
		icons: {
		primary: "ui-icon-folder-open"
		}
	}).click(function(){
		$('#file_load_maptmx').click();
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#save_map" ).button({
		text: false,
		icons: {
		primary: "ui-icon-disk"
		}
	}).click(function(){
		$("#popup_title").html('Save Map');
		$("#popup_content").html('<div id="map_save_dialog">\
			Specify the filename.<br><hr>\
			Filename:<input type="text" id="map_save_dialog_name" ><br>\
			</div>');
		$("#popup_container").show();
		$("#popup_title").show();
		$("#popup_submit").unbind( "click" );
		$("#popup_submit").click(function(){
			saveMap($('#map_save_dialog_name').val() );
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
		$("#popup_cancel").unbind( "click" );
		$("#popup_cancel").click(function(){
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	$( "#save_map_tmx" ).button({
		text: false,
		icons: {
		primary: "ui-icon-disk"
		}
	}).click(function(){
		$("#popup_title").html('Save Map TMX');
		$("#popup_content").html('<div id="map_save_dialog">\
			Specify the filename.<br><hr>\
			Filename:<input type="text" id="map_save_dialog_name" ><br>\
			</div>');
		$("#popup_container").show();
		$("#popup_title").show();
		$("#popup_submit").unbind( "click" );
		$("#popup_submit").click(function(){
			saveMapTmx($('#map_save_dialog_name').val() );
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
		$("#popup_cancel").unbind( "click" );
		$("#popup_cancel").click(function(){
			$("#popup_container").hide();	
			$("#popup_title").hide();				
		});
	}).css('width','14px').find('.ui-button-text').css({'padding':'0px 0px 0px 0px','font-size' : '12px'});
		
	
	$("#display_type").val( (typeof(Storage) !== "undefined" && typeof(localStorage.view) !== "undefined" ? localStorage.view : 0 ) );
	$("#secondary_display_type").val( (typeof(Storage) !== "undefined" && typeof(localStorage.secondary_view) !== "undefined" ? localStorage.secondary_view : 0 ) );
	
	$("#mini_container").css('display',(typeof(Storage) !== "undefined" && typeof(localStorage.mini_container) !== "undefined" ? localStorage.mini_container : 'none' ) );
	$("#map_settings").css('display',(tool.secondary_view==4 ? '' : 'none' ) );
	$("#map_layer_dropdown>option:eq("+tile.layer+")").prop('selected',true)
	$('#map_visible_img').attr('src',(tile.layers[tile.layer].visible==false?'eye-shut.png':'eye-open.png'));
	$("#tab_overview").click();
	$('.scroll-pane').jScrollPane({
		autoReinitialise: true,
		hideFocus: true
	});
	$('#filename').val('image');
	
	//prevent crashes when hitting back button and then forward button(we need to remove the chosen file from the input because hitting back doesn't, and some reason this causes crashes)
	var oldInput = document.getElementById('import_file') ;
	var newInput = document.createElement('input');
	newInput.id    = oldInput.id ;
	newInput.type  = oldInput.type ;
	newInput.name  = oldInput.name ;
	oldInput.parentNode.replaceChild(newInput, oldInput); 
	oldInput = document.getElementById('open_file') ;
	newInput = document.createElement('input');
	newInput.id    = oldInput.id ;
	newInput.type  = oldInput.type ;
	newInput.name  = oldInput.name ;
	oldInput.parentNode.replaceChild(newInput, oldInput); 
	oldInput = document.getElementById('playback_file') ;
	newInput = document.createElement('input');
	newInput.id    = oldInput.id ;
	newInput.type  = oldInput.type ;
	newInput.name  = oldInput.name ;
	oldInput.parentNode.replaceChild(newInput, oldInput); 
	
	$("#menu_file_list form, #form_load_colordex, #form_load_map, #form_load_maptmx, #form_clipart").hide();
	document.getElementById('open_file').addEventListener('change', loadFile, false);
	document.getElementById('import_file').addEventListener('change', importFile, false);
	document.getElementById('playback_file').addEventListener('change', playbackFile, false);
	document.getElementById('file_load_colordex').addEventListener('change', loadColordex, false);
	document.getElementById('file_load_map').addEventListener('change', loadMap, false);
	document.getElementById('file_load_maptmx').addEventListener('change', loadMapTmx, false);
	document.getElementById('import_clipart').addEventListener('change', importClipart, false);
	
	
	
	
	/*
  // Prepare file drop box.
  var box = $('#box');
  box.on('dragenter', doNothing);
  box.on('dragover', doNothing);
  box.on('drop', function(e){
    e.originalEvent.preventDefault();
    var file = e.originalEvent.dataTransfer.files[0];
    eachActiveConnection(function(c, $c) {
      if (c.label === 'file') {
        c.send(file);
        $c.find('.messages').append('<div><span class="file">You sent a file.</span></div>');
      }
    });
  });*/
  function doNothing(e){
    e.preventDefault();
    e.stopPropagation();
  }

	

  // Connect to a peer
  $('#connect')
	.button()
	.click(function() {
		connectTo($('#rid').val().trim());
	});

  // Close a connection.
  $('#close').click(function() {
    eachActiveConnection(function(c) {
      c.close();
    });
  });

  // Send a chat message to all active connections.
  $('#sendmessage').click(function() {
    //e.preventDefault();
    // For each active connection, send the message.
    var msg = {type:'message',text:$('#text').val() };
	eachActiveConnection(function(c) {
      if (c.label === 'chat') {
        c.send(msg);
		//$('#msgbox').append('<div><span class="you">You: </span>: ' + msg.text + '</div>');
        
		//$c.find('.msgbox').append('<div><span class="you">You: </span>' + msg
        //  + '</div>');
      }
    });
	$('#msgbox').append('<div style="direction:ltr;"><span class="you">You: </span>: ' + msg.text + '</div>');
    $('#text').val('');
    $('#text').focus();
  });



  // Show browser version
  $('#browsers').text(navigator.userAgent);
  
  
	$("#app_container").show();
});


  // Goes through each active peer and calls FN on its connections.
  function eachActiveConnection(fn) {
    //var actives = $('.active');
    var checkedIds = {};
    for (var p = peerlist.length-1; p>=0; p--) {
	//peerlist.forEach(function(entry) {
      //if(connectedPeers[entry]==1){
		  var peerId = peerlist[p];

		  if (!checkedIds[peerId]) {
			var conns = peer.connections[peerId];
			for (var i = 0, ii = conns.length; i < ii; i += 1) {
			  var conn = conns[i];
			  //console.log(conn.id);
			//alert(peerlist_id.indexOf(conn.id));
			  if(connlist.indexOf(conn.id)!=-1 )fn(conn);
			}
		  }

		  checkedIds[peerId] = 1;
	  //}
    }
  }

// Make sure things clean up properly.

window.onunload = window.onbeforeunload = function(e) {
  if (!!peer && !peer.destroyed) {
    peer.destroy();
  }
};

function connectTo(p){
	requestedPeer = p;
	if (!connectedPeers[requestedPeer]) {
		//create connection that will first handle a handshake between peers to see if they will draw together
		var c = peer.connect(requestedPeer, {
			label: 'chat',
			serialization: 'binary',
			metadata: { from: peer.id, frames:project.frames, width:project.width, height:project.height, connectionlist: peerlist, message: 'hi i want to chat with you!'}
		});
		c.on('open', function() {
			connect(c);
		});
		c.on('error', function(err) { alert(err); });
		/*
		// Create 2 connections, one labelled chat and another labelled file.
		c = peer.connect(requestedPeer, {
			label: 'draw',
			serialization: 'binary',
			metadata: { connectionlist: peerlist, message: 'hi i want to chat with you!'}
		});
		c.on('open', function() {
			connect(c);
		});
		c.on('error', function(err) { alert(err); });
		var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
		f.on('open', function() {
			connect(f);
		});
		f.on('error', function(err) { alert(err); });
		*/
	}
}
function connectToDraw(p){
	//requestedPeer = p;
	var findPainter = $.grep(peerlist, function(e){ return e == p; });
	if(findPainter.length==0){
		
		// Create 2 connections, one labelled chat and another labelled file.
		var c = peer.connect(p, {
			label: 'draw',
			serialization: 'binary',
			metadata: { from: peer.id, connectionlist: peerlist, message: 'hi i want to chat with you!'}
		});
		c.on('open', function() {
			connect(c);
		});
		c.on('error', function(err) { alert(err); });
		/*
		var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
		f.on('open', function() {
			connect(f);
		});
		f.on('error', function(err) { alert(err); });
		*/
	}
}

</script>
</head> 
 
<body> 
  
	<div style="width:100%; height:100%;">

	
		
		<div align="right" style="position:absolute; bottom:0px; right:0px; width: calc(100% - 256px);">
			<div id="userlist" style=""></div>
			<div align="right" style="width:100%; height:26px; border-top: solid 0px black; background:#444477; vertical-align:middle;">
				<span style="float:left; margin-left:16px; vertical-align:middle; line-height:24px;"><span id="pid"></span><span id="proom"></span></span>
				<span style="margin-left:16px; vertical-align:middle; line-height:24px;">Paint with: <span>
				<input type="text" id="rid" placeholder="Someone else's Alias"><button id="connect">Invite</button>
				<button id="close" style="margin-right:16px;">Disconnect</button>
			</div>
		</div>
		
		
		<div id="console" style="z-index:1; position:absolute; bottom:0px; width: 256px; height: 100%; background:#666666;
		border-width: 0px 4px 0px 0px; 
		border-style: solid; 
		-webkit-border-image: -webkit-gradient(linear, 100% 0, 0 0, from(#444), to(#999999)) 1 100%; 
		-webkit-border-image: -webkit-linear-gradient(right, #444, #999999) 1 100%; 
		-moz-border-image: -moz-linear-gradient(right, #444, #999999) 1 100%; 
		-o-border-image: -o-linear-gradient(right, #444, #999999) 1 100%; 
		border-image: linear-gradient(to right, #444, #999999) 1 100%; ">
			
			
			
			<div id="msgbox" style="direction:rtl; height: calc(100% - 30px); overflow-y:auto; overflow-x:hidden; ">
				
				<!--<img src="logo.png">-->
			
			
		
				<!--<div class="important" style="direction:ltr;">Your browser version: <span id="browsers"></span><br>
				Currently <strong>Firefox 22+ and Google Chrome 26.0.1403.0 or above</strong> is required.</strong>
				</div>-->
				<!--<div style="direction:ltr; text-align:center;">Welcome!</div><br>-->
				<img src="lion.png">
				
			</div>
				
			<div style="position:absolute; width:100%; text-align:center; bottom:2px;">
			
			<div style="direction:ltr; text-align:center;">
					<div id="connect_box" align="center" class="ui-widget-content" style="font-size:9px; font-style:bold; color:#eeeeee; text-align:center; border-radius:6px; padding:6px; display:table; margin: 0 auto; z-index:10; width: 80%; ">
							<input type="text" id="connect_alias" size="16" placeholder="Type an Alias">
							<select id="connect_room" class="tooltip" title="Studio to connect to">
								<option value="0">Magenta</option>
								<option value="1">Violet</option>
								<option value="2">Pink</option>
								<option value="3">Red</option>
								<option value="4">Goldenrod</option>
								<option value="5">Brown</option>
								<option value="6">Orange</option>
								<option value="7">Yellow</option>
								<option value="8">Lime</option>
								<option value="9">Green</option>
								<option value="10">Cyan</option>
								<option value="11" SELECTED>Blue</option>
								<option value="12">Indigo</option>
								<option value="13">Purple</option>
								<option value="14">Black</option>
								<!--<option value="15">Grey</option>
								<option value="16">Silver</option>
								<option value="17">White</option>-->
							</select><br>
							<div class="ui-icon ui-icon-heart" style="display:inline-block;"></div>
							<button onclick="connectStart();" style="float:right; vertical-align:top; margin-top:8px;">Connect</button>
							An alias for this session is required if you will be painting with others, otherwise you can begin painting!
							
					</div>
					<br>
				</div>
				<div id="wacom_detect" style="direction:ltr; text-align:center; display:none;">
					<div align="center" class="ui-widget-content" style="font-size:9px; font-style:bold; color:#eeeeee; text-align:center; border-radius:6px; padding:6px; display:table; margin: 0 auto; z-index:10; width: 80%; ">
							<div class="ui-icon ui-icon-alert" style="display:inline-block;"></div>
							Your Wacom plugin isn't enabled! Check your browser plugin settings to activate it if you want pressure sensitivity.<br>*supported by Firefox
							
					</div>
					<br>
				</div>
			
				<input type="text" id="text" placeholder="Enter message"><input id="sendmessage" class="button" type="submit" value="Send">
				<button id="chat_toggle" class="smallicon">Hide Chat</button>
			</div>
		</div>

		<!--<div id="menu_container" align="center" valign="center" style="position:absolute; top:10px; right:0px; width: calc(100% - 256px); height: calc(100% - 64px); ">
			<div onclick="$('#app_container').show(); setAppSize();" style="width:100px; height:100px; position:absolute; left: 64px; top: calc(50% - 50px); display: table; border:solid 1px black; ">
				Open Paint
			</div>
			<div style="width:calc(100% - 228px); height:100%; position:absolute; right: 0px; top: 0px; display: inline-block; ">
			
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
				<div onclick="" style="width:100px; height:100px; margin:10px; border:solid 1px black; display: inline-block;  ">
					Feature
				</div>
			</div>
			
		</div>-->
		
		<div id="app_container" style="z-index:0; position:absolute; top:0px; right:0px; width: calc(100% - 256px); height: calc(100% - 64px); display:none;">
		
			<div id="canvas_container" style="position:absolute; left: 64px; top:16px; display: table; background:#111111; border:solid 0px black; 
				user-select: none;
				-webkit-user-select: none;
				-moz-user-select: none;">
				<span class="my-header" style="display: block; ">
					<div style="display:inline-block;">
						<div>
							<button id="menu_file" class="transparentbutton">File</button>
							<button id="menu_edit" class="transparentbutton">Edit</button>
							<button id="menu_select" class="transparentbutton">Select</button>
							<button id="menu_window" class="transparentbutton">Window</button>
						</div>
						<ul id="menu_file_list">
							<li><a href="javascript:;">New</a></li>
							<form id="form_open"><input type="file" id="open_file" name="open_file[]" /></form>
							<li><a href="javascript:;" onclick="document.getElementById('open_file').click()">Open</a></li>
							<li><a href="javascript:;">Save</a></li>
							<form id="form_import"><input type="file" id="import_file" name="import_file[]" /></form>
							<li><a href="javascript:;" onclick="document.getElementById('import_file').click()">Import..</a></li>
							<li><a href="javascript:;">Export..</a> 
								<ul>
								<li><a href="javascript:;">Png</a></li>
								<li><a href="javascript:;">Gif</a></li>
								</ul>
							</li>
							<form id="form_playback"><input type="file" id="playback_file" name="playback_file[]" /></form>
							<li><a href="javascript:;" onclick="document.getElementById('playback_file').click()">Playback..</a></li>
							<li><a href="javascript:;" onclick="newFromPlayback(); return false;">New from Playback</a></li>
						</ul>
						<ul id="menu_edit_list">
							<li><a href="javascript:;">Undo</a></li>
							<li><a href="javascript:;">Redo</a></li><hr>
							<li><a href="javascript:;">Cut</a></li>
							<li><a href="javascript:;">Copy</a></li>
							<li><a href="javascript:;">Paste</a></li>
							<li><a href="javascript:;">Clear</a></li><hr>
							<form id="form_clipart"><input type="file" id="import_clipart" name="import_clipart[]" /></form>
							<li><a href="javascript:;" onclick="document.getElementById('import_clipart').click()">Insert Clipart</a></li>
							<li><a href="javascript:;">Frame</a> 
								<ul>
								<li><a href="javascript:;">Add Frame</a></li>
								<li><a href="javascript:;">Remove Frame</a></li>
								</ul>
							</li>
							<li><a href="javascript:;">Image</a> 
								<ul>
								<li><a href="javascript:;">Canvas Size</a></li>
								<li><a href="javascript:;">Image Size</a></li>
								<li><a href="javascript:;">Spritesheet</a></li>
								</ul>
							</li>
							<li><a href="javascript:;">Map</a> 
								<ul>
								<li><a href="javascript:;">Map Size</a></li>
								</ul>
							</li>
							<li><a href="javascript:;">Remove Records</a></li>
							<li name="settings"><a href="javascript:;">Settings</a></li>
						</ul>
						<ul id="menu_select_list">
							<li><a href="javascript:;">Flip Horizontally</a></li>
							<li><a href="javascript:;">Flip Vertically</a></li>
							<li><a href="javascript:;">Rotate Clockwise</a></li>
							<li><a href="javascript:;">Rotate Counter-Clockwise</a></li>
							<li><a href="javascript:;">Crop</a></li>
						</ul>
						<ul id="menu_window_list">
							<li><a href="javascript:;">Frames</a></li>
							<li><a href="javascript:;">History</a></li>
							<li><a href="javascript:;">Color/Tool</a></li>
							<li><a href="javascript:;">Secondary View</a></li>
						</ul>
					</div>
					
					<div id="menu_icons" style="float:right; vertical-align:middle;">
						Filename:<input type="text" id="filename" size="16" placeholder="image" style="height:12px;">
						
						<span id="menu_icons_img" style="">
							<input type="checkbox" id="grid" class="smallicon" data-img="icon-grid2.png"><label for="grid">Grid (Ctrl+')</label>
						</span>
						<button id="settings" class="smallicon">Settings</button>
						<!--<button id="settings" class="smallicon" data-img="icon-gear.png">Settings</button>-->
					</div>
				</span>

				<div id="canvas_bg_color" style="">
					<div id="" class="properties" style="text-align:right; width:100%; background: #333333;">
						<span id="popup_title" style="float:left; display:none; margin-top:4px; margin-left:8px;"></span>
						Primary
						<span id="zoom_text">100%</span>
						<select id="display_type" class="dropdown" onChange="tool.view = this.selectedIndex; if(typeof(Storage) !== 'undefined')localStorage.view = JSON.stringify(tool.view); if(tool.view==3){tool.sheet.x = Math.round(Math.sqrt(project.frames)+(Math.sqrt(project.frames)>Math.floor(Math.sqrt(project.frames))?0.5:0)); tool.sheet.y = Math.round(Math.sqrt(project.frames));}">
							<option value="0" SELECTED>All</option>
							<option value="1">Frame</option>
							<option value="2">Linked</option>
							<option value="3">Sheet</option>
						</select>
						Secondary
						<span id="secondary_zoom_text">100%</span>
						<select id="secondary_display_type" class="dropdown" onChange="tool.secondary_view = this.selectedIndex; if(typeof(Storage) !== 'undefined')localStorage.secondary_view = JSON.stringify(tool.secondary_view); if(tool.secondary_view==3){tool.secondary_sheet.x = Math.round(Math.sqrt(project.frames)+(Math.sqrt(project.frames)>Math.floor(Math.sqrt(project.frames))?0.5:0)); tool.secondary_sheet.y = Math.round(Math.sqrt(project.frames)); } if(tool.secondary_view==4)$('#map_settings').show(); else $('#map_settings').hide(); ">
							<option value="0" SELECTED>All</option>
							<option value="1">Frame</option>
							<option value="2">Linked</option>
							<option value="3">Sheet</option>
							<option value="4">Tiles</option>
						</select>
					</div>
					<ul id="zoom_list" style="position:absolute; z-index:1;">
						<li><a href="javascript:;">100%</a></li>
						<li><a href="javascript:;">200%</a></li>
						<li><a href="javascript:;">300%</a></li>
						<li><a href="javascript:;">400%</a></li>
						<li><a href="javascript:;">500%</a></li>
					</ul>
					<ul id="secondary_zoom_list" style="position:absolute; z-index:1;">
						<li><a href="javascript:;">100%</a></li>
						<li><a href="javascript:;">200%</a></li>
						<li><a href="javascript:;">300%</a></li>
						<li><a href="javascript:;">400%</a></li>
						<li><a href="javascript:;">500%</a></li>
					</ul>
					
					<div id="canvas_bg" style="position:relative; background-image:url('canvas-bg.png'); background-repeat:repeat; border: solid #333333; border-width:0px 6px 6px 6px;">
					<object id="wtPlugin" type="application/x-wacomtabletplugin" WIDTH=1 HEIGHT=1 style="position:absolute; right:0px; top:0px">
						<!-- <param name="onload" value="pluginLoaded" /> -->
					</object>
					<canvas id="canvas" width="512" height="480" style="outline: none;" tabindex="1">Canvas
					</canvas>
					
					
						<!-- miniviewport -->
						<div id="mini_container" style="position:absolute; right: 0px; top:0px; ">
							<div id="minicanvas_bg_color" style="">
								<div id="minicanvas_bg" style="background-image:url('canvas-bg.png'); background-repeat:repeat; border: solid #333333; border-width:0px 0px 6px 6px;">
									<div id="minicanvas_resizer">
										<canvas id="minicanvas" width="160" height="160" style="outline: none;" tabindex="2">Canvas
										</canvas>
										<div id="southwest" class="ui-resizable-handle ui-resizable-sw southwest"></div>
									</div>
								</div>
							</div>
							<div id="map_settings" style="width:100%; background:#333333; display:none;">
								<img id="map_visible_img" src="eye-open.png" title="visible" style="border:0px;" onclick="this.src=(this.src.indexOf('open')!=-1?'eye-shut.png':'eye-open.png'); this.title=(this.src.indexOf('open')!=-1?'visible':'hidden'); tile.layers[parseInt($('#map_layer_dropdown').val())].visible=(tile.layers[parseInt($('#map_layer_dropdown').val())].visible==false?true:false); ">
								<select id="map_layer_dropdown" class="dropdown" onChange="tile.layer = this.selectedIndex; $('#map_visible_img').attr('src',(tile.layers[this.selectedIndex].visible==false?'eye-shut.png':'eye-open.png')); if(typeof(Storage) !== 'undefined')localStorage.map_layer = JSON.stringify(tile.layer); ">
									<option value="0" SELECTED>0</option>
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
								</select>
								<span style="display: block; float:right; text-align:right;">
									<form id="form_load_map"><input type="file" id="file_load_map" name="file_load_map[]" /></form>
									<form id="form_load_maptmx"><input type="file" id="file_load_maptmx" name="file_load_maptmx[]" /></form>
									<button id="save_map_image" class="smallicon smallericon">Export Image</button>
									<button id="load_map_tmx" class="smallicon smallericon">Load Tmx</button>
									<button id="save_map_tmx" class="smallicon smallericon">Export Tmx</button>
									<button id="load_map" class="smallicon smallericon">Load</button>
									<button id="save_map" class="smallicon smallericon">Save Map</button>
								</span>
							</div>
						</div>
						
						<!-- popup thing -->
						<div id="popup_container" style="position:absolute; left: 0px; top:0px; display:none;">
							<div id="popup_bg" style="background: #888888; border: solid #333333; border-width:0px 6px 6px 0px; padding:10px;">
								<div id="popup_content" style=""></div>
								<button id="popup_submit">Submit</button>
								<button id="popup_cancel">Cancel</button>
							</div>
						</div>
					</div>
				</div>
				
				<!-- toolbar -->
				<div style="position:absolute; left: 0px; top:32px;">
					<div id="toolbar" class="ui-widget-header ui-corner-all my-toolbar" style="position:absolute; right: 6px; top: 0px; padding:3px; display: table;
					">
						<div><button id="eraser" class="smallicon" data-img="icon-eraser.png" value="0">Eraser (E)</button></div>
						<div><button id="magiceraser" class="smallicon" data-img="icon-magiceraser.png">Magic Eraser (E)</button></div>
						<div><button id="pencil" class="smallicon" data-img="icon-pencil.png" value="0">Pencil (B)</button></div>
						<div><button id="brush" class="smallicon" data-img="icon-brush.png">Brush (B)</button></div>
						<div><button id="bucket" class="smallicon" data-img="icon-bucket.png">Flood Fill (G)</button></div>
						<div><button id="marquee" class="smallicon" data-img="icon-marquee.png">Marquee (M)</button></div>
						<div><button id="lasso" class="smallicon" data-img="icon-lasso.png">Lasso (L)</button></div>
						<div><button id="magicwand" class="smallicon" data-img="icon-magicwand.png">Magic Wand (W)</button></div>
						<div><button id="eyedropper" class="smallicon" data-img="icon-eyedropper.png">Eyedropper (I)</button></div>
						<div><button id="hand" class="smallicon" data-img="icon-hand.png">Hand (H)</button></div>
						<div><button id="zoom" class="smallicon" data-img="icon-zoom.png">Zoom (Z)</button></div>
						<div><button id="tile" class="smallicon" data-img="icon-tile.png">Tile (T)</button></div>
						<div><button id="erasetile" class="smallicon" data-img="icon-erasetile.png">Remove Tile (R)</button></div>
						<div><button id="collision" class="smallicon" data-img="icon-collision.png">Collision (C)</button></div>
					</div>
				</div>
				
					
				<div style="position:absolute; right: 0px; bottom:0px;">
				<!--record -->
					<div id="record_container" class="ui-widget-content ui-corner-all" style="position:absolute; right: 0px; top:6px; display: table; 
						user-select: none;
						-webkit-user-select: none;
						-moz-user-select: none;
						background-size:100% 100%;">
						<span class="my-header" style="display: block; ">Playback to Gif</span>
						<span style="position:absolute; top:0px; right:0px;">
							<button id="record_reset" class="smallicon smallericon">Reset</button>
							<input type="checkbox" id="record_button" ><label for="record_button">Off</label>
							<button id="record_save" class="smallicon smallericon">Save</button>
							<button id="record_settings" class="smallicon smallericon">Save</button>
						</span>
						<div style="padding:3px;">
							<table><tr><td align="right">
								<div style="display:inline; white-space: nowrap;">
								<input type="checkbox" id="record_transparency">
								<input type="color" id="record_color" align="right" class="tooltip" title="Color in the image that will become transparent.">
								</div><br>
								<div style="display:inline; white-space: nowrap;">Speed:<input type="text" class="recordspinner" id="record_speed" ></div>
								<select id="record_scale" class="tooltip" title="The scale of the exported gif.">
									<option value="1" SELECTED>100%</option>
									<option value="2">200%</option>
									<option value="3">300%</option>
									<option value="4">400%</option>
									<option value="5">500%</option>
									<option value="6">600%</option>
									<option value="7">700%</option>
									<option value="8">800%</option>
									<option value="9">900%</option>
									<option value="10">1000%</option>
								</select>
							</td><td valign="bottom">
								<div style="display:inline; white-space: nowrap;">
								Capture interval: <input type="text" id="record_keyframe" size="4" class="recordspinner tooltip" title="Capture a frame every X actions from playback.">
								</div><br>
								Frames Captured: <span id="record_count" data-capture="true">0</span><br>
								<div id="record_progressbar" style="width:100%; height:8px;"></div>
							</td></tr></table>
							
							<span style="position:absolute; bottom:0px; right:0px;">
								<div id="record_progressbar" style="width:100px; height:8px;"></div>
							</span>
						</div>
					</div>
				</div>
				
				<div id="lowerleft_anchor" style="position:absolute; left: 0px; bottom:0px;">
				<!-- playback -->
					<div id="playback_container" class="my-container ui-widget-content ui-corner-all properties" style="position:absolute; left: 0px; top:6px; display: table; 
						user-select: none;
						-webkit-user-select: none;
						-moz-user-select: none;
						background-size:100% 100%;
						border: solid 6px #333333;">
						<div id="playback_slider"></div>
						<span style="white-space: nowrap;">
							<div id="playback_toolbar" style="display:inline; white-space: nowrap;">
								<button id="playback_start">start</button>
								<button id="playback_previous">previous</button>
								<button id="playback_play">play</button>
								<button id="playback_stop">stop</button>
								<button id="playback_next">next</button>
								<button id="playback_end">end</button>
							</div>
							<div style="display:inline;"><input type="text" class="pickertextbox" id="playback_speed" ></div>
						</span>
					</div>
				
				<!-- colorpicker / properties / colordex-->
					
					<div id="colorpicker_container" class="my-container properties"  style="position:absolute; left: 0px; top:6px; display: table; 
						user-select: none;
						-webkit-user-select: none;
						-moz-user-select: none;
						background-size:100% 100%;
						border: solid 6px #333333;">
						<span class="" style="display: block; width:100%;">&nbsp;</span>
						<span style="position:absolute; top:0px; left:0px;"><div id="rgb_hsl_radio">
							<input type="radio" id="radio1" name="radio" checked="checked"><label for="radio1">RGB</label>
							<input type="radio" id="radio2" name="radio"><label for="radio2">HSL</label>
						</div></span>
						
						<!-- colordex -->
						<span style="position:absolute; top:0px; left:80px;">
							<input type="checkbox" id="colordex_radio"><label for="colordex_radio">Colordex</label>
							<input type="checkbox" id="palette_radio"><label for="palette_radio">Palette</label>
						</span>
						<div style="position:absolute; top:0px; left:0px; ">
							<div style="position:absolute; bottom: 0px; ">
							<div id="colordex_container" style="  display: none; 
								user-select: none;
								-webkit-user-select: none;
								-moz-user-select: none;">
								
								<span style="display: block; width:100%; text-align:right; background: #222222;">
									<form id="form_load_colordex"><input type="file" id="file_load_colordex" name="file_load_colordex[]" /></form>
									<button id="load_colordex" class="smallicon smallericon">Load</button>
									<button id="save_colordex" class="smallicon smallericon">Save</button>
									<input type="checkbox" id="lock_colordex"><label for="lock_colordex">Lock</label>
								</span>
								
								<div style="position:relative; bottom: 0px; background: rgba(255,255,255,0.25); border:solid 2px white; 
									user-select: none;
									-webkit-user-select: none;
									-moz-user-select: none;">
									<canvas id="palettecanvas" width="128" height="128" style="">Canvas
									</canvas>
									<!--<span class="ui-widget-header" style="display: block; width:100%;">Colordex</span>
									-->
									<div id="colordex_start" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; background: url('colordex-start.png');"></div>
									<div id="colordex_end" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; background: url('colordex-end.png');"></div>
									<div id="colordex_endup" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; background: url('colordex-endup.png');"></div>
									<div id="colordex2_start" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; opacity:0.25; background: url('colordex-start.png');"></div>
									<div id="colordex2_end" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; opacity:0.25; background: url('colordex-end.png');"></div>
									<div id="colordex2_endup" style="position:absolute; top:0px; left:0px; width:16px; height:16px; pointer-events:none; opacity:0.25; background: url('colordex-endup.png');"></div>
								</div>
							</div>
							</div>
						</div>
						
						
						<!-- palette -->
						<div style="position:absolute; top:0px; right:0px; ">
							<div id="palette_bounds" style="position:absolute; width:100px; ">
							<div id="palette_container" style="background: rgba(0,0,0,0.5);  width:100%; height:100%; display: none; 
								user-select: none;
								-webkit-user-select: none;
								-moz-user-select: none;">
								
								<span style="display: block; width:100%; text-align:right; background: #333333;">
									<select id="scan_palette_dropdown" class="dropdown" onChange="if(typeof(Storage) !== 'undefined')localStorage.scan_palette_dropdown = JSON.stringify(this.selectedIndex); ">
										<option value="0" SELECTED>All</option>
										<option value="1">Frame</option>
									</select>
									<button id="scan_palette" class="">Scan</button>
								</span>
								<div id="palette_box" style="font-size:0;"></div>
							</div>
							</div>
						</div>
						
						
						<table><tr><td align="right" style="white-space: nowrap; vertical-align:top; font-size:8px;">
						<div style="display:inline-block; vertical-align:top; ">
						<div id="red"></div>
						<div id="green"></div>
						<div id="blue"></div>
						</div>
						<div style="display:inline-block; vertical-align:top; font-size:5px;">
						<input type="text" class="pickertextbox" id="redvalue" ><br>
						<input type="text" class="pickertextbox" id="greenvalue" ><br>
						<input type="text" class="pickertextbox" id="bluevalue" ><br>
						</div>
						<div style="display:inline-block; position:relative; vertical-align:top; width:48px; height:48px; background:none;">
							<div id="swatch" class="ui-widget-content ui-corner-all" style="z-index:1; position:absolute; top:0px; left;0px; width:32px; height:32px; background:none;" onclick="mouse.currentColor=0; $(this).css('z-index',1); $('#swatch2').css('z-index',0); currentColorGroup = 0; eyedropColor({r:mouse.rgb.r,g:mouse.rgb.g,b:mouse.rgb.b}); "></div>
							<div id="swatch2" class="ui-widget-content ui-corner-all" style="z-index:0; position:absolute; bottom:0px; right:0px; width:32px; height:32px; background:none;" onclick="mouse.currentColor=1; $(this).css('z-index',1); $('#swatch').css('z-index',0); currentColorGroup = 1; eyedropColor({r:mouse.rgb2.r,g:mouse.rgb2.g,b:mouse.rgb2.b}); "></div>
						</div>
						
						<!-- preset buttons -->
						<div id="brush_presets">
							<input type="radio" id="preset1" name="preset" value="1" checked="checked"><label for="preset1">1</label>
							<input type="radio" id="preset2" name="preset" value="2" ><label for="preset2">2</label>
							<input type="radio" id="preset3" name="preset" value="3" ><label for="preset3">3</label>
							<input type="radio" id="preset4" name="preset" value="4" ><label for="preset4">4</label>
							<input type="radio" id="preset5" name="preset" value="5" ><label for="preset5">5</label>
							<input type="radio" id="preset6" name="preset" value="6" ><label for="preset6">6</label>
							<input type="radio" id="preset7" name="preset" value="7" ><label for="preset7">7</label>
							<input type="radio" id="preset8" name="preset" value="8" ><label for="preset8">8</label>
							<input type="radio" id="preset9" name="preset" value="9" ><label for="preset9">9</label>
							<input type="radio" id="preset0" name="preset" value="0" ><label for="preset0">0</label>
						</div>
						</td><td style="vertical-align:top; font-size:8px;">
						
						<div id="brush_settings">
							<table><tr><td style="vertical-align:top; font-size:8px;">
								<div id="tool_size"><span style="position:absolute;">Size:</span></div>
								<div id="tool_opacity"><span style="position:absolute;">Strength:</span></div>
								<div id="tool_hardness"><span style="position:absolute;">Softness:</span></div>
								<div id="tool_levels"><span style="position:absolute;">Steps:</span></div>
								</td><td style="vertical-align:middle; font-size:5px;">
								<div id="pencontrols">
								<button id="pencontrol_size" class="smallicon penicon" data-img="icon-none.png">None</button><br>
								<button id="pencontrol_opacity" class="smallicon penicon" data-img="icon-none.png">None</button><br>
								<button id="pencontrol_hardness" class="smallicon penicon" data-img="icon-none.png">None</button><br>
								<button id="pencontrol_levels" class="smallicon penicon" data-img="icon-none.png">None</button>
								</div>
							</td><td valign="top">
								<div class="ui-widget-content ui-corner-all" style="width:70px; height:70px; overflow:hidden; background:url(canvas-bg.png) repeat; "> 
								<canvas id="toolcanvas" width="64" height="64" style="top: 50%; left: 50%;  margin-left: -100%; position: relative;">Brush
								</canvas>
								</div>
							</td></tr></table>
						</div>
						<div id="bucket_settings">
							<span >
								<input type="checkbox" id="contiguous"><label for="contiguous">Contiguous</label>
							</span>
						</div>
						
						</td></tr></table>
					</div>
					
			
				</div>
				
					
				
				<div style="position:absolute; right: -6px; top:0px; height:100%;">
					
					<!-- containers -->
					<div style="position:absolute; left:0px; height:100%;">
						<div id="window_slider" class="my-container" style="width:90px; border: solid 6px #333333;">
							<span class="" style="display: block; width:100%;">&nbsp;</span>
						</div>
						<div id="window_slider2" class="my-container" style="width:90px; border: solid 6px #333333;">
							<span class="" style="display: block; width:100%;">&nbsp;</span>
						</div>
					</div>
					
					<!-- historylist -->
					<div id="history_container" style="position:absolute; top: 32px; left:0px; width:90px; ">
						<span class="my-header" style="display: block; ">History</span>
						<div class="my-container" style="border: solid 6px #333333;">
						<div id="history_box" style="height:64px; overflow-x:hidden; overflow-y: auto;">
						<ol id="historyresize_list">
							<li id="historyresize_null" value="-1" class="" >Original</li>
						</ol>
						<ol id="history_list">
							<li id="history_null" value="-1" class="" >Original</li>
						</ol>
						</div>
						<span id="history_resizer" class="resizer" class="" style="display: block; width:100%;">&nbsp;</span>
						</div>
					</div>
					
					<!-- frames -->
					<div id="frame_container" style="position:absolute; bottom: 0px; left:0px; display: table;">
						<span class="my-header" style="display: block; ">Frames</span>
						<div class="my-container" style="border: solid 6px #333333;">
						<div id="frame_transparency"></div>
						<div id="frame_box" style="overflow-x: auto; overflow-y: hidden;">
						<ul id="frame_list" data-droploc="0">
							<li id="frame_null" value="-1" data-interval="300" class="ui-widget-content " style="background:url(canvas-bg.png) repeat;"><span class="handle"></span></li>
						</ul>
						</div>
						<div style="position:absolute;">
						<ul id="interval_menu" style="z-index:10;">
							<li><a href="javascript:;">0</a></li>
							<li><a href="javascript:;">0.1</a></li>
							<li><a href="javascript:;">0.2</a></li>
							<li><a href="javascript:;">0.5</a></li>
							<li><a href="javascript:;">1</a></li>
							<li><a href="javascript:;">custom</a></li>
						</ul>
						</div>
						<span id="frame_resizer" class="resizer" style="display: block; width:100%;">&nbsp;</span>
						<div style="position:absolute; top:0px; right:0px;">
							<button id="frame_orientation_toggle" value="0" >Horizontal/Vertical</button>
						</div>
						<div style="position:absolute; top:0px; right:0px;">
							<button id="frame_play" value="0" >Play</button>
							<!-- <input type="checkbox" id="frame_showall"><label for="frame_showall">All Frames</label> -->
						</div>
						<div class="properties" style="position:absolute; bottom:6px; left:6px;">
						</div>
						</div>
					</div>
					
				</div>
				
				
	
			</div>
			
			<!--
			<div id="properties_container" class="ui-widget-header ui-corner-all" style="position:absolute; bottom:0px; left: 400px;  display: table; 
				user-select: none;
				-webkit-user-select: none;
				-moz-user-select: none;">
				<span class="" style="display: block; width:100%;">Properties</span>
				<table><tr><td>
				<div id="tool_size"></div>
				<div id="tool_opacity"></div>
				<div id="tool_hardness"></div>
				<div id="tool_levels"></div>
				</td><td style="font-size:5px;">
				<div id="pencontrols">
				<button id="pencontrol_size" data-img="icon-pencil.png">None</button>
				</div>
				</td><td>
				<div style="width:64px; height:64px; overflow:hidden; "> 
				<canvas id="toolcanvas" width="64" height="64" style="top: 50%; left: 50%;  margin-left: -100%; position: relative;">Brush
				</canvas>
				</div>
				</td></tr></table>
			</div>
			-->
			
			
			
			
		
		</div>
		
	</div>
  


  <div style="position:relative; background: #bbbbbb; font-size: 18px; width:100%; height:256px; text-align: center; border-top: solid 4px #888888;">
		
		<div class="bottomtext" style="float:left; vertical-align:middle; width:256px; height:100%; display:table;">
			<div style="padding:10px 16px 16px 16px; font-size:13px; text-align:center; display:table-cell; vertical-align:middle;">
			<img src="network.png" style="border:0px; "><br>
			<strong><font style="font-size:24px; line-height:24px;">T</font>he world's first pixel-art editor allowing artists to paint together online!
			</strong><br><br><font style="font-size:12px;">*Network support only in Chrome & Firefox browsers currently.</font>
			</div>
		</div>
		
		<div id="information" class="bottomtext" style="width:calc(80% - 256px); height:100%; float:left; vertical-align:bottom; display:inline-block; ">
			<div id="infobox" class="infobox scroll-pane" style="height:100%; overflow: auto; ">
				<div id="infobox_content" class="" style="padding:16px 16px 16px 16px; ">
			
				<div id="info_overview" style="display:none; padding:8px;">
					Allow me to introduce myself, my name is Alex Hanson-White, and I primarily create pixel-art for a living. In my free time I like to code video games, but recently I've been developing this pixel-art editor out of my love for the medium and all the amazing artists that work with it. My hope is that by developing this editor I will be helping give back to the community a resource that will enable a new fun and rewarding way to create pixel-art. I've briefly outlined below a few main features that set this editor apart from the rest. 
					<table>
					<tr><td valign="top" width="">
					<ul>
						<li><strong>Pixel with others simultaneously!</strong> This is the main reason why I created this editor. With all my years of pixeling, I've never came across a tool with this ability that is geared towards pixel artists. I believe it will be useful for game projects with multiple artists or for quick gamejam asset creation between collaborators. It can also be great for tutoring sessions, or other fun collaborations.<br></li>
						<li>You can <strong>record the entire process</strong> and also replay it. This allows everyone to share and relive each other's work step by step, offering an exciting way to appreciate a work of art. You can also branch off anywhere in the replay and pixel it a new direction.</li>
						<li>The <strong>Colordex</strong> system that makes it easy to apply multiple colors intelligently with a single brush stroke while maintaining order of any specific color ramping you've defined. I was inspired by the HD Index Painting technique my friend Dan Fessler popularized, however I found that technique a hassle to manage, and the software expensive. The Colordex system I created solves these issues, allowing you to focus on pixeling. The best way to understand how it works is to experience it yourself.</li>
					
					</ul> 
					</td></tr>
					</table>
				</div>
				<div id="info_features" style="display:none;">
					<table>
					<tr><td valign="top">
					<dl>
						<dt>Animation</dt>
							<dd>Each frame acts as a cell in an animation. Turning a frame's visibility off by clicking its' eye icon will exclude it from the animation. You can set a frame's duration, and also link frames together. Linked frames are combined into one frame when animating. To play the animation, click the play button in the header of the Frames window. Click the same button again to stop the animation.</dd>
						<dt>Crop Image</dt>
							<dd>After making a selection via a selection tool, selecting Crop in the selection menu will resize the canvas around the selection. Due to possible networking scenarios, any previous crop/image resize/canvas resize won't be able to be undone if this operation is made as this operation will clear the History. You will still be able to undo this operation, unless you make another resize in the future.</dd>
						<dt>Export/Import Gifs</dt>
							<dd>To import a gif, choose import from the File menu and select a gif file. It will begin processing each frame into a new project. Exporting a gif is simple, when you have an animation that is ready to be exported, go to export under the File menu and select Gif. A box will display that contains a property for the transparency color. Clicking this property will allow you to select which color you'd want to be transparent in the gif. Clicking submit will begin processing the gif which you can then save.</dd>
						<dt>Export/Import Spritesheets</dt>
							<dd>To import a spritesheet, first import the image file by selecting import from under the File menu. After it has loaded, select Spritesheet from under the edit menu. A box will display that contains properties pertaining to the columsn and rows in the spritesheet and the direction the animations are organized. When you click submit, the spritesheet will get sliced up according to your settings and create frames for each cell. To export a spritesheet, go to export under File menu and select Png. A box will display that contains a dropdown menu with the option for a spritesheet. Selecting this option will reveal settings for columns and rows along with the direction the animations are organized. Clicking submit will create the spritesheet and allow you to save it.</dd>
						<dt>Flip/Rotate Selection</dt>
							<dd>After making a selection, it can be flipped hoizontally and vertically by choosing the corresponding item under the Selection menu. You can also rotate it 90 degrees clockwise or counter-clockwise. Alternatively, there is a round handle next to any selection you make, that you can click and drag to rotate it an arbitrary angle.</dd>
						<dt>Frames</dt>
							<dd>Each frame has a thumbnail, and a handle. Clicking and dragging the handle to the left of the thumbnail allows reordering of the frames. You can select multiple frames by clicking and dragging the thumbnails, which will become highlighted to signify their selected state. You can reorder multiple frames, and also set their duration by clicking the lower right number in a thumbnail. Clicking a frame's eye icon will toggle its visibility on and off. Invisible frames are skipped when playing an animation. Frames have a transparency value which you can set by dragging the bar above the thumbnails. </dd>
						<dt>Grid snapping</dt>
							<dd>Holding shift down while dragging a selection will snap it to the grid. You can also change the grid size in the settings.</dd>
						<dt>History</dt>
							<dd>Each action you make that applies a change to the canvas will be saved in the history, allowing you to revert to previous steps either by clicking an action in the history list, selecting undo/redo from the edit menu, or pressing ctrl+z or ctrl+y. Crop, canvas resize, and image resize actions share one undo. So if you make two crop/image resize/canvas resize, you'll only be able to undo the last one. They also clear the History. The only way to revert further back is to save your work, then play it back to the moment before that action is made, and then branch off a new project from that point.</dd>
						<dt>Hotkeys & Shortcuts</dt>
							These are key combinations you can press that allow you to control the editor easily. You can find a list of these in the Hotkeys tab.
						<dt>Layers/Frames</dt>
							<dd>Frames act like layers. The lower layers in the list will be displayed below the others while the higher layers in the list will be displayed above.</dd>
						<dt>Linked Layers/Frames</dt>
							<dd></dd>
						<dt>Resize Selection/Image/Canvas</dt>
						<dt>Rotation Algorithm</dt>
						<dt>Selection Tools</dt>
							<dd>After selecting a portion of the image with the lasso, marquee or magic wand tool, you can hold Ctrl while you click and drag the selection to clip it from the image and reposition it. Holding Ctrl and Alt when you click and drag will clone it instead of clipping it completely from the image. Holding down the Ctrl key while you move a selection will snap it to the grid. You can click outside of the selection deselect and set the clipped portion into the image, or press Ctrl+D to deselect. Pressing Delete key will clear the clipped selection, or the portion of the canvas if nothing was clipped. The arrow keys can be used to help position the selection pixel by pixel. You can also hold Shift while you use a selection tool to add to any current selection, or hold Alt to subtract from the selection, or press both to XOR the selection. After clipping a selection, handles will appear that allow you to resize and rotate the clipped selection.</dd>
						<dt>Tileset/Map Tools</dt>
						<dt>Tool customization</dt>
						<dt>Wacom web plugin</dt>
						<dt>Zoom</dt>
					</dl> 
					</td></tr>
					</table>
				</div>
				<div id="info_colordex" style="display:none; padding:8px;">
					<a target="_blank" href="http://youtu.be/QGLg-N9RT44">Click here</a> for a video demonstration on how to use the Colordex.<br>
					The Colordex is a system that integrates color ramps into your brush strokes so that the color you paint isn't simply a single color, but rather multiple colors of a color ramp. You can have multiple color ramps interacting together while you apply or remove colors. Steps for quickly setting up your brush is outlined below.
					<br><br>
					<ol>
						<li>Click the Colordex button to open your palette, or press the X key. This is where you will organize your colors.</li>
						<li>With either the pencil or brush tool, draw your color ramps with each consecutive color touching the previous color drawn. It might make it easier to draw if you increase your brush size.</li>
						<li>Once you're satisfied with your colors, hold Ctrl key and Left click a color that will act as your target color(the color your brush will draw towards). A circle icon will appear over the location you clicked.</li>
						<li>With the Ctrl key held, Right click this time on another color that you'll want to erase towards, but make sure it is a color on the same color ramp as the target color(There must be a sequence of colors connected between them if they aren't neighboring each other).</li>
						<li>At this point, the Colordex will be set to erase towards your chosen color and stop there, but if you want it to continue erasing to the transparent canvas you can right click a blank part of the canvas instead of a color, but you'll need to mark where on a color ramp the Colordex should step on and off from. When you right click, you hold the mouse button down and drag the small square onto a color to solve this decision. If you don't do this, the system won't know which color to create if it's drawing from transparency therefor preventing any color to be drawn from a transparent section of the image.</li>
						<li>You're now ready to draw. Choose the Brush tool to utilize the colordex with your strokes, and choose the Magic Eraser to utilize the colordex while you erase. Tip: You can hold Alt to sample colors you've drawn, which will shift your target color in your colordex. You also can have multiple color ramps connected together, or separate. It's up to your imagination how you want to organize your Colordex.</li>
					</ol>
				</div>
				<div id="info_hotkeys" style="display:none;">
					<table>
					<tr><td valign="top">
					<ul>
						<li>Eraser/Magic Eraser (E)<br>hold key to swap between.</li>
						<li>Pencil/Brush (B)<br>hold key to swap between.</li>
						<li>Flood Fill (G)</li>
						<li>Marquee (M)</li>
						<li>Lasso (L)</li>
						<li>Magic Wand (W)</li>
						<li>Eyedropper (I)</li>
						<li>Hand (H)</li>
					</ul> 
					</td><td valign="top">
					<ul>
						<li>Zoom (Z)</li>
						<li>Tile (T)</li>
						<li>Remove Tile (R)</li>
						<li>Collision </li><hr>
						<li>Undo (Ctrl+Z)</li>
						<li>Redo (Ctrl+Y)</li>
						<li>Copy (Ctrl+C)</li>
						<li>Paste (Ctrl+V)</li>
						<li>Deselect (Ctrl+D)</li>
					</ul>
					</td><td valign="top">
					<ul>
						<li>Swap Colors (X)</li>
						<li>Colordex (C)</li>
						<li>Zoom in (Ctrl+=)</li>
						<li>Zoom out (Ctrl+-)</li><hr>
						<li>Grid Snap (Ctrl+Leftmouse)</li>
						<li>Remove Selection (Delete)</li>
						<li>Draw Straight Line (Shift)</li>
						<li>Eyedrop canvas (Alt)</li>
						<li>Size Increase (])</li>
						<li>Size Decrease ([)</li>
						<li>Tool preset (0-9)</li>
					</ul>
					</td><td valign="top">
					<ul>
						<li>Move Selection (Arrows)</li>
						<li>Cut Selection (Ctrl+Click)</li>
						<li>Copy Selection (Ctrl+Alt+Click)</li>
						<li>Add Selection (Shift+Click)</li>
						<li>Subtract Selection (Alt+Click)</li>
						<li>Xor Selection (Shift+Alt+Click)</li>
						<li>Zoom out (Spacebar+Alt)</li>
						<li>Zoom in (Spacebar+Ctrl)</li>
						<li>Secondary Viewport (V)</li>
					</ul>
					</td></tr>
					</table>
				</div>
				<div id="info_help" style="display:none;">
					<a target="_blank" href="http://youtu.be/QGLg-N9RT44">How to use the Colordex</a>
				</div>
			
				</div>
			</div>
			<div id="tab_overview" class="infotab" style="display:inline-block; " onclick="$('#infobox_content').children().hide(); $('#info_overview').toggle();">
				Overview
			</div>
			<div id="tab_features" class="infotab" style="display:inline-block; " onclick="$('#infobox_content').children().hide(); $('#info_features').toggle();">
				Features
			</div>
			<div id="tab_colordex" class="infotab" style="display:inline-block; " onclick="$('#infobox_content').children().hide(); $('#info_colordex').toggle();">
				Colordex
			</div>
			<div id="tab_hotkeys" class="infotab" style="display:inline-block; " onclick="$('#infobox_content').children().hide(); $('#info_hotkeys').toggle();">
				Hotkeys
			</div>
			<div id="tab_help" class="infotab" style="display:inline-block; " onclick="$('#infobox_content').children().hide(); $('#info_help').toggle();">
				Help
			</div>
		</div>

		<div class="bottomtext" style="float:right; vertical-align:top; height:100%; width:20%; display:table;">
			<div style="padding:24px 16px 16px 16px; text-align:center; vertical-align:bottom; display:table-cell;">
				<img src="face.png" style=""><br>
				By <a href="http://www.alexhw.com">Alex Hanson-White</a><br><hr>
				<i><font style="font-size:24px; line-height:24px;">T</font>his editor is free to use, but developing it takes time & energy. Support the pixel-art community. Inspire the world one pixel at a time.</i>
				<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
				<input type="hidden" name="cmd" value="_s-xclick">
				<input type="hidden" name="hosted_button_id" value="KANPEAR5KRLRJ">
				<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
				<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
				</form>
			</div>
		</div>

  </div>
  
  
  
</body> 
</html> 
